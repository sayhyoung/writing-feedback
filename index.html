<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Writing Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet"/>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background: #f5f7fa; }
        .header-gradient { background: linear-gradient(90deg,#1e3a8a 0%,#2563eb 100%); }
        .tab-active { color: #2563eb; border-bottom: 3px solid #2563eb; font-weight:600; }
        .modal { position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);
                 display:none;align-items:center;justify-content:center; }
    </style>
</head>
<body>

  <!-- 메인 페이지 -->
  <div class="main-page">
    <!-- 헤더 -->
    <header class="header-gradient text-white p-4 shadow-lg">
      <div class="container mx-auto flex flex-col items-center">
        <div class="flex items-center">
          <i class="fas fa-pen-fancy text-2xl mr-3"></i>
          <h1 class="text-2xl font-bold">Writing Assistant</h1>
        </div>
        <p class="text-sm mt-1">글쓰기 피드백 시스템</p>
      </div>
    </header>

    <div class="container mx-auto p-4">
      <!-- 학생 정보 -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6 flex flex-col md:flex-row md:space-x-6">
        <div class="flex-1">
          <label class="block text-gray-700 mb-2">학생 이름</label>
          <input id="student-name" type="text" placeholder="학생의 이름을 입력하세요"
                 class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500"/>
        </div>
        <div class="flex-1 mt-4 md:mt-0">
          <label class="block text-gray-700 mb-2">센터</label>
          <input id="center-name" type="text" placeholder="센터 이름을 입력하세요"
                 class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500"/>
        </div>
      </div>

      <!-- 글쓰기 입력 -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex items-center mb-4">
          <i class="fas fa-edit text-blue-600 mr-2"></i>
          <h2 class="text-lg font-semibold">글쓰기 입력</h2>
        </div>
        <label class="block text-gray-700 mb-2">영작 내용을 입력하거나 이미지를 업로드하세요</label>
        <div class="action-icons flex justify-end gap-2 mb-2">
          <button type="button" class="icon-btn bg-white p-2 rounded-md shadow hover:bg-gray-100">
            📷<input type="file" id="camera-input" accept="image/*" capture="environment"/>
          </button>
          <button type="button" class="icon-btn bg-white p-2 rounded-md shadow hover:bg-gray-100">
            🖼️<input type="file" id="gallery-input" accept="image/*"/>
          </button>
        </div>
        <textarea id="userWriting"
                  class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 mb-2"
                  rows="6">Yesterday, I go to the park with my friends.
The weather is very good and we are happy.
After playing, I bought some ice cream for my friends.
It was very delicious.
I think that this day is most happy day in this month.
We played basketball for two hours.</textarea>
        <button id="getFeedbackBtn"
                class="bg-blue-600 text-white px-6 py-2 rounded-md shadow hover:bg-blue-700 transition">
          Get Feedback
        </button>
      </div>

      <!-- 피드백 섹션 -->
      <div id="feedbackSection" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
        <div class="flex justify-between items-center mb-4">
          <div class="flex items-center">
            <i class="fas fa-comment-dots text-blue-600 mr-2"></i>
            <h2 class="text-lg font-semibold">피드백</h2>
          </div>
          <button id="editFeedbackBtn"
                  class="text-sm text-gray-600 hover:text-gray-900">Edit</button>
        </div>
        <div id="feedbackContent"><!-- JS 삽입 --></div>
        <div id="correctedContent" class="mt-6"><!-- JS 삽입 --></div>
        <div class="flex justify-end mt-6">
          <button id="printBtn"
                  class="bg-blue-600 text-white px-6 py-2 rounded-md shadow hover:bg-blue-700 flex items-center">
            <i class="fas fa-print mr-2"></i> Print
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Print 옵션 모달 -->
  <div id="printModal" class="modal">
    <div class="modal-content bg-white p-6 rounded-lg">
      <h3 class="text-xl font-semibold text-blue-600 mb-4">Print Options</h3>
      <div class="print-options mb-4">
        <label class="block"><input type="checkbox" id="opt-orig" checked/> 원본</label>
        <label class="block"><input type="checkbox" id="opt-fb" checked/> 피드백</label>
        <label class="block"><input type="checkbox" id="opt-corr" checked/> 수정글</label>
      </div>
      <div class="flex justify-end space-x-4">
        <button id="cancelPrint" class="px-4 py-2 bg-gray-200 rounded-md">Cancel</button>
        <button id="confirmPrint"
                class="px-4 py-2 bg-blue-600 text-white rounded-md">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Print 전용 섹션 -->
  <div class="print-page p-8">
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-blue-800">🚀 윤선생 리얼 스피치</h1>
      <p class="text-lg text-gray-600">글쓰기 피드백 결과</p>
      <div class="mt-4">
        <span class="font-medium">이름:</span> <span id="printName"></span>
         
        <span class="font-medium">센터:</span> <span id="printCenter"></span>
         
        <span class="font-medium">날짜:</span> <span id="printDate"></span>
      </div>
    </div>
    <div id="printOrig" class="mb-6"><!-- 원본 --></div>
    <div id="printFb" class="mb-6"><!-- 피드백 --></div>
    <div id="printCorr" class="mb-6"><!-- 수정글 --></div>
  </div>

  <script>
    // Utility
    function el(q){return document.querySelector(q);}
    function show(q){el(q).classList.remove('hidden');}
    function hide(q){el(q).classList.add('hidden');}

    // 날짜 세팅
    const today = new Date();
    const ds = `${today.getFullYear()}년 ${today.getMonth()+1}월 ${today.getDate()}일`;
    el('#printDate').textContent = ds;

    // Get Feedback
    el('#getFeedbackBtn').onclick = async () => {
      const txt = el('#userWriting').value;
      // TODO: 이미지 OCR 있으면 contentText 대신 OCR 결과 전송
      const res = await fetch('/api/feedback', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ contentText: txt })
      });
      const { feedback, modelAnswer } = await res.json();
      // 1) insert feedback cards (HTML 그대로 삽입)
      el('#feedbackContent').innerHTML = feedback;
      el('#correctedContent').innerHTML = `
        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
          ${modelAnswer}
        </div>`;
      show('#feedbackSection');
    };

    // Edit 버튼
    let editing = false;
    el('#editFeedbackBtn').onclick = () => {
      const cnt = el('#feedbackContent');
      if (!editing) {
        const ta = document.createElement('textarea');
        ta.id = 'fb-edit';
        ta.className = 'w-full p-2 border rounded';
        ta.value = cnt.innerText.trim();
        cnt.replaceWith(ta);
        el('#editFeedbackBtn').textContent='Save';
      } else {
        const ta = el('#fb-edit');
        const div = document.createElement('div');
        div.id='feedbackContent';
        div.innerHTML = ta.value.replace(/\n/g,'<br>');
        ta.replaceWith(div);
        el('#editFeedbackBtn').textContent='Edit';
      }
      editing = !editing;
    };

    // Print flow
    el('#printBtn').onclick = ()=>el('#printModal').style.display='flex';
    el('#cancelPrint').onclick = ()=>el('#printModal').style.display='none';
    el('#confirmPrint').onclick = ()=>{
      // 학생정보
      el('#printName').textContent   = el('#student-name').value || '(미입력)';
      el('#printCenter').textContent = el('#center-name').value || '(미입력)';
      // 원본
      if(el('#opt-orig').checked) {
        el('#printOrig').innerHTML = `
          <h2 class="text-xl font-bold mb-2">원본 작성글</h2>
          <pre>${el('#userWriting').value}</pre>`;
      } else el('#printOrig').innerHTML='';
      // 피드백
      if(el('#opt-fb').checked)
        el('#printFb').innerHTML = `<h2 class="text-xl font-bold mb-2">피드백</h2>` +
          el('#feedbackContent').outerHTML;
      else el('#printFb').innerHTML='';
      // 수정글
      if(el('#opt-corr').checked)
        el('#printCorr').innerHTML = `<h2 class="text-xl font-bold mb-2">수정글</h2>` +
          el('#correctedContent').innerHTML;
      else el('#printCorr').innerHTML='';
      el('#printModal').style.display='none';
      window.print();
    };
  </script>
</body>
</html>
