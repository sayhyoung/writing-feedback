<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Writing Feedback</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; padding: 1rem; }
    .loader { display: none; }
    .box { border: 1px solid #ccc; padding: 1rem; margin-bottom: 1rem; }
    button { position: relative; }
    #result { margin-top: 2rem; }
    @media print { .no-print { display: none; } }
  </style>
</head>
<body>
  <h1>Writing Feedback</h1>
  <form id="feedback-form" enctype="multipart/form-data">
    <label>Topic/Title (optional)
      <input type="text" name="topic" id="topic" placeholder="Enter topic or leave blank">
    </label>
    <label>Keywords (optional)
      <input type="text" name="keywords" id="keywords" placeholder="Comma-separated keywords">
    </label>
    <label>Content Text (optional)
      <textarea name="contentText" id="contentText" rows="4" placeholder="Paste your writing here"></textarea>
    </label>
    <label>Content Image (optional)
      <input type="file" name="contentFile" id="contentFile" accept="image/*">
    </label>
    <label>Level
      <select name="level" id="level">
        <option value="초급">초급</option>
        <option value="중급">중급</option>
        <option value="고급">고급</option>
      </select>
    </label>
    <button type="submit" id="submit-btn">Submit</button>
    <img src="spinner.gif" alt="Loading..." class="loader" id="submit-loader" width="24">
  </form>

  <div id="result"></div>

  <script>
    const WORKER_URL = 'https://writing-feedback-app.sehyunglee2015.workers.dev';
    const submitBtn = document.getElementById('submit-btn');
    const submitLoader = document.getElementById('submit-loader');

    document.getElementById('feedback-form').addEventListener('submit', async e => {
      e.preventDefault();
      submitBtn.disabled = true;
      submitLoader.style.display = 'inline';

      const formData = new FormData(e.target);
      const res = await fetch(`${WORKER_URL}/api/feedback`, { method: 'POST', body: formData });
      const data = await res.json();

      submitBtn.disabled = false;
      submitLoader.style.display = 'none';

      const result = document.getElementById('result');
      if (!res.ok) {
        result.innerHTML = `<p style="color:red;">Error ${res.status}: ${data.error?.message || JSON.stringify(data)}</p>`;
        return;
      }

      const { feedback, modelAnswer } = data;
      result.innerHTML = `
        <div class="box">
          <h2>Feedback</h2>
          <p>${feedback.replace(/\n/g, '<br>')}</p>
        </div>
        <div class="box" id="model-wrapper">
          <h3 style="text-align:center; text-transform: capitalize; font-size:1.5rem; line-height:1.5;">${document.getElementById('topic').value || 'Model Answer'}</h3>
          <p id="model-answer" style="font-size:1rem; line-height:1.5;">${modelAnswer.replace(/\n/g, '<br>')}</p>
          <button id="print-model" class="no-print">Print Model Answer</button>
        </div>
      `;

      const printBtn = document.getElementById('print-model');
      const printLoader = document.createElement('img');
      printLoader.src = 'spinner.gif';
      printLoader.width = 24;
      printLoader.className = 'loader';
      printBtn.insertAdjacentElement('afterend', printLoader);

      printBtn.addEventListener('click', () => {
        printBtn.disabled = true;
        printLoader.style.display = 'inline';
        const html = `<!DOCTYPE html><html><head><title>Print Answer</title><style>body{font-family:sans-serif;margin:2rem;}h3{text-align:center;font-size:2rem;line-height:1.5;}p{font-size:1.2rem;line-height:1.5;}@media print{button{display:none;}}</style></head><body>${document.getElementById('model-wrapper').innerHTML}</body></html>`;
        const w = window.open('', '_blank');
        w.document.write(html);
        w.document.close();
        w.focus();
        w.print();
        w.onafterprint = () => {
          w.close(); printBtn.disabled = false; printLoader.style.display = 'none';
        };
      });
    });
  </script>
</body>
</html>
