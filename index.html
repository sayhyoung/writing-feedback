<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Writing Assistant</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="font-sans bg-gray-100 flex justify-center p-8">
  <div id="container" class="w-full max-w-2xl bg-white rounded-xl shadow-md p-8 relative">

    <!-- Header -->
    <h1 class="text-3xl font-bold text-center text-blue-700 mb-6">🤖 Writing Assistant</h1>
    <button id="reset-btn" class="absolute top-6 right-6 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded transition">Reset</button>

    <!-- Tabs -->
    <nav class="flex justify-center mb-6 space-x-4">
      <button id="tab-feedback" class="px-4 py-2 font-semibold bg-blue-600 text-white rounded">피드백 코너</button>
      <button id="tab-final" class="px-4 py-2 font-semibold bg-blue-100 text-blue-600 rounded hover:bg-blue-200">최종 산출물 코너</button>
    </nav>

    <!-- Feedback Section -->
    <section id="feedback-section" class="block">
      <form id="feedback-form">
        <label class="block text-gray-700 font-medium mb-2">영작 내용을 입력하거나 이미지를 업로드하세요</label>
        <div class="flex justify-end gap-2 mb-2">
          <button type="button" class="w-8 h-8 bg-white rounded-lg shadow flex items-center justify-center relative cursor-pointer hover:bg-gray-100 transition" title="사진 촬영">📷
            <input type="file" id="contentFile-camera-feedback" accept="image/*" capture="environment" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
          </button>
          <button type="button" class="w-8 h-8 bg-white rounded-lg shadow flex items-center justify-center relative cursor-pointer hover:bg-gray-100 transition" title="이미지 선택">🖼️
            <input type="file" id="contentFile-gallery-feedback" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
          </button>
        </div>
        <textarea id="contentText-feedback" class="w-full min-h-[150px] p-4 border-2 border-gray-300 rounded-lg bg-gray-50 resize-y focus:outline-none focus:border-blue-600 transition text-sm" placeholder="여기에 텍스트를 입력하세요"></textarea>
        <div id="file-info-feedback" class="hidden mt-1 p-2 bg-blue-100 rounded flex text-sm">
          <span class="flex-1 text-blue-700 font-medium file-name"></span>
        </div>
        <div id="ocr-status-feedback" class="hidden mt-1 p-2 bg-yellow-100 border border-yellow-300 rounded flex items-center gap-2 text-yellow-800">
          <div class="w-4 h-4 border-2 border-yellow-800 border-t-transparent rounded-full animate-spin spinner"></div>
          <span>이미지에서 텍스트를 추출 중입니다...</span>
        </div>
        <button type="submit" id="submit-feedback-btn" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded inline-flex items-center transition">
          Get Feedback
          <div id="submit-spinner-feedback" class="hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin ml-2 spinner"></div>
        </button>
      </form>

      <div id="feedback-result"></div>

      <!-- Print Modal -->
      <div id="feedback-print-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
        <div class="bg-white p-6 rounded-lg w-11/12 max-w-md">
          <h3 class="text-xl font-semibold text-blue-700 mb-4">Print Options</h3>
          <div class="print-options mb-4">
            <label class="flex items-center mb-2"><input type="checkbox" id="print_orig_fb" checked class="mr-2">원본</label>
            <label class="flex items-center mb-2"><input type="checkbox" id="print_fb_fb" checked class="mr-2">피드백</label>
            <label class="flex items-center mb-2"><input type="checkbox" id="print_corr_fb" checked class="mr-2">수정글</label>
          </div>
          <div class="flex justify-end space-x-4">
            <button id="confirm-print-feedback-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded transition">Confirm</button>
            <button id="cancel-print-feedback-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded transition">Cancel</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Final Section -->
    <section id="final-section" class="hidden">
      <form id="final-form">
        <label class="block text-gray-700 font-medium mb-2">최종 결과물을 위해 텍스트를 입력하거나 이미지를 업로드하세요</label>
        <div class="flex justify-end gap-2 mb-2">
          <button type="button" class="w-8 h-8 bg-white rounded-lg shadow flex items-center justify-center relative cursor-pointer hover:bg-gray-100 transition" title="사진 촬영">📷
            <input type="file" id="contentFile-camera-final" accept="image/*" capture="environment" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
          </button>
          <button type="button" class="w-8 h-8 bg-white rounded-lg shadow flex items-center justify-center relative cursor-pointer hover:bg-gray-100 transition" title="이미지 선택">🖼️
            <input type="file" id="contentFile-gallery-final" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
          </button>
        </div>
        <textarea id="contentText-final" class="w-full min-h-[150px] p-4 border-2 border-gray-300 rounded-lg bg-gray-50 resize-y focus:outline-none focus:border-blue-600 transition text-sm" placeholder="여기에 텍스트를 입력하세요"></textarea>
        <div id="file-info-final" class="hidden mt-1 p-2 bg-blue-100 rounded flex text-sm">
          <span class="flex-1 text-blue-700 font-medium file-name"></span>
        </div>
        <div id="ocr-status-final" class="hidden mt-1 p-2 bg-yellow-100 border border-yellow-300 rounded flex items-center gap-2 text-yellow-800">
          <div class="w-4 h-4 border-2 border-yellow-800 border-t-transparent rounded-full animate-spin spinner"></div>
          <span>이미지에서 텍스트를 추출 중입니다...</span>
        </div>
        <button type="submit" id="submit-final-btn" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded inline-flex items-center transition">
          Generate Final
          <div id="submit-spinner-final" class="hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin ml-2 spinner"></div>
        </button>
      </form>

      <div id="final-result"></div>

      <!-- Print Modal -->
      <div id="final-print-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
        <div class="bg-white p-6 rounded-lg w-11/12 max-w-md">
          <h3 class="text-xl font-semibold text-blue-700 mb-4">Print Options</h3>
          <div class="print-options mb-4">
            <label class="flex items-center mb-2"><input type="checkbox" id="print_orig_fn" checked class="mr-2">원본</label>
            <label class="flex items-center mb-2"><input type="checkbox" id="print_fb_fn" class="mr-2">피드백</label>
            <label class="flex items-center mb-2"><input type="checkbox" id="print_corr_fn" checked class="mr-2">수정글</label>
          </div>
          <div class="flex justify-end space-x-4">
            <button id="confirm-print-final-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded transition">Confirm</button>
            <button id="cancel-print-final-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded transition">Cancel</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    const WORKER_URL = 'https://writing-feedback-app.sehyunglee2015.workers.dev';
    const PROXY_URL  = WORKER_URL + '/proxy';

    window.feedbackFileURL = '';
    window.finalFileURL    = '';

    // Reset 버튼
    document.getElementById('reset-btn').onclick = () => {
      ['feedback','final'].forEach(sec => {
        document.getElementById(`contentText-${sec}`).value = '';
        document.getElementById(`file-info-${sec}`).classList.add('hidden');
        document.getElementById(`ocr-status-${sec}`).classList.add('hidden');
        if (window[`${sec}FileURL`]) window[`${sec}FileURL`] = '';
        document.getElementById(`${sec}-result`).innerHTML = '';
      });
    };

    // 탭 전환 (Tailwind 방식)
    document.getElementById('tab-feedback').onclick = () => {
      document.getElementById('feedback-section').classList.remove('hidden');
      document.getElementById('final-section').classList.add('hidden');
      document.getElementById('tab-feedback').classList.add('bg-blue-600','text-white');
      document.getElementById('tab-feedback').classList.remove('bg-blue-100','text-blue-600');
      document.getElementById('tab-final').classList.add('bg-blue-100','text-blue-600');
      document.getElementById('tab-final').classList.remove('bg-blue-600','text-white');
    };
    document.getElementById('tab-final').onclick = () => {
      document.getElementById('final-section').classList.remove('hidden');
      document.getElementById('feedback-section').classList.add('hidden');
      document.getElementById('tab-final').classList.add('bg-blue-600','text-white');
      document.getElementById('tab-final').classList.remove('bg-blue-100','text-blue-600');
      document.getElementById('tab-feedback').classList.add('bg-blue-100','text-blue-600');
      document.getElementById('tab-feedback').classList.remove('bg-blue-600','text-white');
    };

    // 파일 업로드 & OCR
    ['feedback','final'].forEach(section => {
      ['camera','gallery'].forEach(src => {
        const input = document.getElementById(`contentFile-${src}-${section}`);
        input.addEventListener('change', async e => {
          const file = e.target.files[0];
          if (!file) return;
          const url = URL.createObjectURL(file);
          window[`${section}FileURL`] = url;
          const info = document.getElementById(`file-info-${section}`);
          info.querySelector('.file-name').textContent = file.name;
          info.classList.remove('hidden');
          doOCR(file, section);
        });
      });
    });

    async function doOCR(file, section) {
      const status = document.getElementById(`ocr-status-${section}`);
      status.classList.remove('hidden');
      try {
        const b64 = await new Promise((res, rej) => {
          const reader = new FileReader();
          reader.onload = () => res(reader.result.split(',')[1]);
          reader.onerror = rej;
          reader.readAsDataURL(file);
        });
        const resp = await fetch(PROXY_URL, {
          method: 'POST',
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [{ role: 'user', content: [{ type: 'text', text: 'Please extract the exact text from the image as it appears. Do not provide any additional commentary.' }, { type: 'image_url', image_url: { url: `data:${file.type};base64,${b64}` } }] }],
            max_tokens: 500
          })
        });
        const { choices } = await resp.json();
        document.getElementById(`contentText-${section}`).value = (choices[0]?.message?.content || '').trim();
      } catch(err) {
        document.getElementById(`contentText-${section}`).value = 'OCR 에러: ' + err.message;
      } finally {
        status.classList.add('hidden');
      }
    }

    // Feedback & Final submissions (unchanged)
    document.getElementById('feedback-form').addEventListener('submit', async e => { /* ... */ });
    document.getElementById('final-form').addEventListener('submit', async e => { /* ... */ });
  </script>
</body>
</html>
