<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Writing Assistant</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #f0f4f8; margin: 0; padding: 2rem;
      display: flex; justify-content: center; line-height: 1.6;
    }
    #container {
      width:100%; max-width:700px;
      background:#fff; border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
      padding:2rem; position:relative;
    }
    h1 { text-align:center; color:#004a99; margin-bottom:1rem; }
    nav { text-align:center; margin-bottom:1rem; }
    .tab {
      background:#e9f5ff; color:#004a99;
      border:none; padding:.5rem 1rem;
      margin:0 .5rem; border-radius:4px;
      cursor:pointer; font-weight:bold;
    }
    .tab.active { background:#0066cc; color:#fff; }
    .section { display:none; }
    .section.active { display:block; }

    form { margin-bottom:1.5rem; }
    label { display:block; margin:.75rem 0 .25rem; color:#004a99; font-weight:600; }
    textarea, input[type="file"] {
      width:100%; padding:.5rem;
      border:1px solid #cbd7e0; border-radius:4px;
      background:#f9fcff; box-sizing:border-box;
    }
    textarea { resize:vertical; }

    /* Ïà®Í∏∞Í∏∞: ÌååÏùº ÏûÖÎ†•Ïùò Í∏∞Î≥∏ ÌÅ¥Î¶¨Ïñ¥/Î¶¨Îπå Î≤ÑÌäº */
    input[type=file]::-ms-clear,
    input[type=file]::-ms-reveal { display:none; width:0; height:0; }

    button {
      background:#0066cc; color:#fff;
      border:none; border-radius:4px;
      padding:.75rem 1.5rem; cursor:pointer;
      transition:background .2s; margin-top:1rem;
    }
    button:hover { background:#0052a3; }
    .spinner {
      display:none; width:16px; height:16px;
      border:2px solid #0066cc; border-top:2px solid transparent;
      border-radius:50%; animation:spin 1s linear infinite;
      vertical-align:middle; margin-left:.5rem;
    }
    #tts-spinner { border:2px solid red; border-top:2px solid transparent; }
    @keyframes spin { to{transform:rotate(360deg);} }

    .box, .model-box {
      background:#fff; border-radius:4px;
      padding:1rem; margin-top:1rem;
    }
    .box h2, .model-box h2 { margin:0 0 .5rem; color:#004a99; }
    .model-box { font-size:1.1rem; line-height:1.5; }

    /* Print Options Modal */
    #print-modal {
      display:none; position:fixed; top:0; left:0;
      width:100%; height:100%; background:rgba(0,0,0,0.5);
      justify-content:center; align-items:center;
    }
    #print-modal .modal-content {
      background:#fff; padding:1.5rem; border-radius:4px;
      width:90%; max-width:400px;
    }
    #print-modal label { display:block; margin:.5rem 0; }
    #print-modal button { margin-right:.5rem; }

    #download-link {
      display:none!important; margin-top:1rem;
      color:#0066cc; text-decoration:none; font-weight:600;
    }

    @media print {
      nav, button, #reset-btn, #print-modal { display:none!important; }
      body { background:#fff; margin:0; }
    }
  </style>
</head>
<body>
  <div id="container">
    <h1>ü§ñ Writing Assistant</h1>
    <button id="reset-btn">Reset</button>
    <nav>
      <button id="tab-feedback" class="tab active">ÌîºÎìúÎ∞± ÏΩîÎÑà</button>
      <button id="tab-final" class="tab">ÏµúÏ¢Ö ÏÇ∞Ï∂úÎ¨º ÏΩîÎÑà</button>
    </nav>

    <!-- ÌîºÎìúÎ∞± ÏΩîÎÑà -->
    <section id="feedback-section" class="section active">
      <form id="feedback-form">
        <label>ÌÖçÏä§Ìä∏ ÎòêÎäî Ïù¥ÎØ∏ÏßÄ
          <textarea id="contentText-feedback" rows="4" placeholder="ÌÖçÏä§Ìä∏ ÏûÖÎ†•"></textarea>
          <input type="file" id="contentFile-feedback" accept="image/*"/>
          <span id="ocr-spinner-feedback" class="spinner"></span>
        </label>
        <button type="submit" id="submit-feedback-btn">
          Get Feedback<span id="submit-spinner-feedback" class="spinner"></span>
        </button>
      </form>
      <div id="feedback-result"></div>
    </section>

    <!-- ÏµúÏ¢Ö ÏÇ∞Ï∂úÎ¨º ÏΩîÎÑà -->
    <section id="final-section" class="section">
      <form id="final-form">
        <label>ÌÖçÏä§Ìä∏ ÎòêÎäî Ïù¥ÎØ∏ÏßÄ
          <textarea id="contentText-final" rows="4" placeholder="ÌÖçÏä§Ìä∏ ÏûÖÎ†•"></textarea>
          <input type="file" id="contentFile-final" accept="image/*"/>
          <span id="ocr-spinner-final" class="spinner"></span>
        </label>
        <button type="submit" id="submit-final-btn">
          Generate Final<span id="submit-spinner-final" class="spinner"></span>
        </button>
      </form>
      <div id="final-result"></div>
    </section>
  </div>

  <!-- Print Options Modal -->
  <div id="print-modal">
    <div class="modal-content">
      <h2>Print Options</h2>
      <label><input type="checkbox" id="opt-original" checked> ÏõêÎ≥∏</label>
      <label><input type="checkbox" id="opt-feedback"> ÌîºÎìúÎ∞±</label>
      <label><input type="checkbox" id="opt-corrected" checked> ÏàòÏ†ïÍ∏Ä</label>
      <button id="print-confirm-btn">Confirm</button>
      <button id="print-cancel-btn">Cancel</button>
    </div>
  </div>

  <script>
    const WORKER_URL = 'https://writing-feedback-app.sehyunglee2015.workers.dev';
    const PROXY_URL  = WORKER_URL + '/proxy';

    let fbImageURL = null;
    let fnImageURL = null;
    let printContext = null;
    let lastFeedback = '';

    // Reset
    document.getElementById('reset-btn').onclick = () => {
      ['feedback','final'].forEach(ctx => {
        document.getElementById(`contentText-${ctx}`).value = '';
        document.getElementById(`${ctx}-result`).innerHTML = '';
        document.getElementById(`contentFile-${ctx}`).value = '';
      });
      fbImageURL = fnImageURL = null;
    };

    // Tab switch
    ['feedback','final'].forEach(ctx => {
      document.getElementById(`tab-${ctx}`).onclick = () => {
        ['feedback','final'].forEach(c => {
          document.getElementById(`tab-${c}`)
            .classList.toggle('active', c===ctx);
          document.getElementById(`${c}-section`)
            .classList.toggle('active', c===ctx);
        });
      };
    });

    // OCR + preview store
    async function handleOCR(fileId, textId, spinId, store) {
      const file = document.getElementById(fileId).files[0];
      if (!file) return;
      const ta = document.getElementById(textId);
      const sp = document.getElementById(spinId);
      ta.value = 'Ïù¥ÎØ∏ÏßÄÏóêÏÑú ÌÖçÏä§Ìä∏ Ï∂îÏ∂ú Ï§ë‚Ä¶';
      sp.style.display = 'inline-block';

      const url = URL.createObjectURL(file);
      if (store === 'fb') fbImageURL = url;
      if (store === 'fn') fnImageURL = url;

      const b64 = await new Promise((res,rej) => {
        const r = new FileReader();
        r.onload = () => res(r.result.split(',')[1]);
        r.onerror = rej;
        r.readAsDataURL(file);
      });

      try {
        const r = await fetch(PROXY_URL, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [{
              role: 'user',
              content: [
                { type:'text', text:'Please extract the exact text from the image as it appears. Do not provide any additional commentary.' },
                { type:'image_url', image_url:{ url:`data:${file.type};base64,${b64}` } }
              ]
            }],
            max_tokens: 500
          })
        });
        const { choices } = await r.json();
        ta.value = choices[0]?.message?.content?.trim() || '';
      } catch(err) {
        ta.value = 'OCR ÏóêÎü¨: ' + err.message;
      } finally {
        sp.style.display = 'none';
      }
    }
    document.getElementById('contentFile-feedback')
      .onchange = () => handleOCR('contentFile-feedback','contentText-feedback','ocr-spinner-feedback','fb');
    document.getElementById('contentFile-final')
      .onchange = () => handleOCR('contentFile-final','contentText-final','ocr-spinner-final','fn');

    // Feedback submit
    document.getElementById('feedback-form').onsubmit = async e => {
      e.preventDefault();
      const btn = document.getElementById('submit-feedback-btn');
      const sp  = document.getElementById('submit-spinner-feedback');
      btn.disabled = true; sp.style.display = 'inline-block';

      const content = document.getElementById('contentText-feedback').value;
      const res = await fetch(`${WORKER_URL}/api/feedback`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ contentText: content })
      });
      const { feedback, modelAnswer } = await res.json();
      lastFeedback = feedback;
      btn.disabled = false; sp.style.display = 'none';

      document.getElementById('feedback-result').innerHTML = `
        <div class="box" id="fb-box">
          <h2>Feedback</h2>
          <div id="fb-content">${feedback.replace(/\n/g,'<br>')}</div>
          <button id="edit-feedback-btn">Edit Feedback</button>
        </div>
        <div class="box">
          <h2>ÏàòÏ†ïÍ∏Ä</h2>
          <div class="model-box" id="fb-corrected">${modelAnswer.replace(/\n/g,'<br>')}</div>
        </div>
        <button id="print-feedback-btn">Print</button>
      `;

      // Edit Feedback
      document.getElementById('edit-feedback-btn').onclick = function() {
        const ta = document.getElementById('fb-edit');
        if (ta) {
          const newDiv = document.createElement('div');
          newDiv.id = 'fb-content';
          newDiv.innerHTML = ta.value.replace(/\n/g,'<br>');
          ta.replaceWith(newDiv);
          this.textContent = 'Edit Feedback';
        } else {
          const d = document.getElementById('fb-content');
          const textarea = document.createElement('textarea');
          textarea.id = 'fb-edit';
          textarea.style.width = '100%';
          textarea.style.height = '150px';
          textarea.value = d.innerText;
          d.replaceWith(textarea);
          this.textContent = 'Save';
        }
      };

      // Print Feedback ‚Üí modal
      document.getElementById('print-feedback-btn').onclick = () => {
        printContext = 'feedback';
        document.getElementById('opt-feedback').checked = true;
        document.getElementById('opt-original').checked = Boolean(fbImageURL || document.getElementById('contentText-feedback').value.trim());
        document.getElementById('opt-corrected').checked = true;
        document.getElementById('print-modal').style.display = 'flex';
      };
    };

    // Final submit
    document.getElementById('final-form').onsubmit = async e => {
      e.preventDefault();
      const btn = document.getElementById('submit-final-btn');
      const sp  = document.getElementById('submit-spinner-final');
      btn.disabled = true; sp.style.display = 'inline-block';

      const content = document.getElementById('contentText-final').value;
      const res = await fetch(`${WORKER_URL}/api/feedback`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ contentText: content })
      });
      const { feedback, modelAnswer } = await res.json();
      lastFeedback = feedback;
      btn.disabled = false; sp.style.display = 'none';

      document.getElementById('final-result').innerHTML = `
        <div class="box" id="fn-box">
          <h2>ÏàòÏ†ïÍ∏Ä</h2>
          <div class="model-box" id="fn-corrected">${modelAnswer.replace(/\n/g,'<br>')}</div>
          <button id="edit-final-btn">Edit Final</button>
        </div>
        <button id="tts-btn">ÏõêÏñ¥ÎØº ÏùåÏÑ± Îì£Í∏∞<span id="tts-spinner" class="spinner"></span></button>
        <audio id="tts-audio" controls style="display:none;"></audio>
        <a id="download-link">Download Audio</a>
        <button id="print-model-btn">Print</button>
      `;

      // Edit Final
      document.getElementById('edit-final-btn').onclick = function() {
        const ta = document.getElementById('fn-edit');
        if (ta) {
          const newDiv = document.createElement('div');
          newDiv.className = 'model-box';
          newDiv.id = 'fn-corrected';
          newDiv.innerHTML = ta.value.replace(/\n/g,'<br>');
          ta.replaceWith(newDiv);
          this.textContent = 'Edit Final';
        } else {
          const d = document.getElementById('fn-corrected');
          const textarea = document.createElement('textarea');
          textarea.id = 'fn-edit';
          textarea.style.width = '100%';
          textarea.style.height = '150px';
          textarea.value = d.innerText;
          d.replaceWith(textarea);
          this.textContent = 'Save';
        }
      };

      // TTS
      document.getElementById('tts-btn').onclick = async () => {
        const tbtn = document.getElementById('tts-btn');
        const tsp  = document.getElementById('tts-spinner');
        const dl   = document.getElementById('download-link');
        const au   = document.getElementById('tts-audio');
        tbtn.disabled = true; tsp.style.display = 'inline-block'; dl.style.display = 'none';
        try {
          const elem = document.getElementById('fn-edit') || document.getElementById('fn-corrected');
          const txt  = elem.value || elem.innerText;
          const rr   = await fetch(`${WORKER_URL}/api/tts`, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ text: txt })
          });
          if (!rr.ok) throw new Error(rr.statusText);
          const blob = await rr.blob();
          const url  = URL.createObjectURL(blob);
          au.src = url; au.style.display = 'block';
          dl.href = url; dl.download = 'model-answer.mp3'; dl.style.display = 'block';
        } catch(err) {
          alert('TTS ÏóêÎü¨: ' + err.message);
        } finally {
          tsp.style.display = 'none';
          tbtn.disabled = false;
        }
      };

      // Print Final ‚Üí modal
      document.getElementById('print-model-btn').onclick = () => {
        printContext = 'final';
        document.getElementById('opt-feedback').checked = false;
        document.getElementById('opt-original').checked = Boolean(fnImageURL || document.getElementById('contentText-final').value.trim());
        document.getElementById('opt-corrected').checked = true;
        document.getElementById('print-modal').style.display = 'flex';
      };
    };

    // Modal handlers
    document.getElementById('print-cancel-btn').onclick = () => {
      document.getElementById('print-modal').style.display = 'none';
    };
    document.getElementById('print-confirm-btn').onclick = () => {
      const o  = document.getElementById('opt-original').checked;
      const f  = document.getElementById('opt-feedback').checked;
      const c  = document.getElementById('opt-corrected').checked;
      document.getElementById('print-modal').style.display = 'none';
      let html = '<!doctype html><html><head><meta charset="utf-8"/><title>Print</title>'
               + '<style>body{font-family:sans-serif;padding:2rem;}@media print{button{display:none}}</style>'
               + '</head><body>';
      if (printContext==='feedback') {
        if (o) {
          if (fbImageURL) html += `<h2>ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄ</h2><img src="${fbImageURL}" style="max-width:100%;"/>`;
          else html += `<h2>ÏõêÎ≥∏</h2><pre>${document.getElementById('contentText-feedback').value}</pre>`;
        }
        if (f) html += `<h2>Feedback</h2>${document.getElementById('fb-content').outerHTML}`;
        if (c) html += `<h2>ÏàòÏ†ïÍ∏Ä</h2>${document.getElementById('fb-corrected').outerHTML}`;
      } else {
        if (o) {
          if (fnImageURL) html += `<h2>ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄ</h2><img src="${fnImageURL}" style="max-width:100%;"/>`;
          else html += `<h2>ÏõêÎ≥∏</h2><pre>${document.getElementById('contentText-final').value}</pre>`;
        }
        if (f) html += `<h2>Feedback</h2>${lastFeedback.replace(/\n/g,'<br>')}`;
        if (c) html += `<h2>ÏàòÏ†ïÍ∏Ä</h2>${document.getElementById('fn-corrected').outerHTML}`;
      }
      html += '<script>window.print();window.onafterprint=()=>window.close();<\/script></body></html>';
      const w = window.open(); w.document.write(html); w.document.close();
    };
  </script>
</body>
</html>
