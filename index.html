<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Writing Assistant</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #f0f4f8;
      margin: 0; padding: 2rem;
      display: flex; justify-content: center;
      line-height: 1.6;
    }
    #container {
      width: 100%; max-width: 700px;
      background: #fff; border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 2rem; position: relative;
    }
    h1 { text-align: center; color: #004a99; margin-bottom: 1rem; }
    
    /* Reset button */
    #reset-btn {
      position: absolute;
      top: 2rem;
      right: 2rem;
      background: #0066cc;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: background .2s;
      margin: 0;
    }
    #reset-btn:hover { background: #0052a3; }
    
    /* Tabs */
    nav { text-align: center; margin-bottom: 1rem; }
    .tab {
      background: #e9f5ff; color: #004a99;
      border: none; padding: .5rem 1rem;
      margin: 0 .5rem; border-radius: 4px;
      cursor: pointer; font-weight: bold;
    }
    .tab.active { background: #0066cc; color: #fff; }
    .section { display: none; }
    .section.active { display: block; }
    
    /* Form */
    form { margin-bottom: 1.5rem; }
    label { display: block; margin: .75rem 0 .25rem; color: #004a99; font-weight: 600; }
    
    /* Unified Input Container */
    .input-container {
      width: 100%;
    }
    
    .input-area {
      width: 100%;
      min-height: 150px;
      padding: 1rem;
      border: 2px solid #cbd7e0;
      border-radius: 8px;
      background: #f9fcff;
      box-sizing: border-box;
      resize: vertical;
      font-family: inherit;
      font-size: 14px;
      line-height: 1.5;
      transition: border-color 0.3s ease;
    }
    
    .input-area:focus {
      outline: none;
      border-color: #0066cc;
    }
    
    .input-area.has-image {
      background: #e9f5ff;
      border-color: #0066cc;
    }
    
    /* Action Icons */
    .action-icons {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    .icon-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 6px;
      background: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.2s ease;
    }
    
    .icon-btn:hover {
      background: #f0f4f8;
      transform: translateY(-1px);
    }
    
    .icon-btn input[type="file"] {
      position: absolute;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }
    
    /* File Preview */
    .file-info {
      margin-top: 0.5rem;
      padding: 0.5rem;
      background: #e9f5ff;
      border-radius: 4px;
      display: none;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }
    
    .file-info.show {
      display: flex;
    }
    
    .file-info .file-name {
      flex: 1;
      color: #004a99;
      font-weight: 500;
    }
    
    .file-info .remove-file {
      background: #ff4444;
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      cursor: pointer;
      font-size: 12px;
    }
    
    /* OCR Status */
    .ocr-status {
      margin-top: 0.5rem;
      padding: 0.5rem;
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 4px;
      color: #856404;
      font-size: 0.9rem;
      display: none;
      align-items: center;
      gap: 0.5rem;
    }
    
    .ocr-status.show {
      display: flex;
    }
    
    /* Buttons */
    button {
      background: #0066cc; color: #fff;
      border: none; border-radius: 4px;
      padding: .75rem 1.5rem; cursor: pointer;
      transition: background .2s; margin-top: 1rem;
    }
    button:hover { background: #0052a3; }
    
    .spinner {
      display: none; width:16px; height:16px;
      border:2px solid #0066cc; border-top:2px solid transparent;
      border-radius:50%; animation:spin 1s linear infinite;
      vertical-align:middle; margin-left:.5rem;
    }
    #tts-spinner { border:2px solid red; border-top:2px solid transparent; }
    @keyframes spin { to{transform:rotate(360deg);} }
    
    /* Boxes */
    .box, .model-box {
      background: #fff; border-radius:4px;
      padding:1rem; margin-top:1rem;
    }
    .box h2, .model-box h2 { margin:0 0 .5rem; color:#004a99; }
    .model-box { font-size:1.1rem; line-height:1.5; }
    
    /* Print options */
    .print-options { margin-top:1rem; }
    .print-options label { margin-right:1rem; font-weight:normal; }
    
    /* Download link */
    #download-link {
      display:none!important;
      margin-top:1rem;color:#0066cc;text-decoration:none;font-weight:600;
    }
    
    @media print {
      nav, button, #reset-btn { display:none!important; }
      body { background:#fff; margin:0; }
    }
  </style>
</head>
<body>
  <div id="container">
    <h1>ğŸ¤– Writing Assistant</h1>
    <button id="reset-btn">Reset</button>
    <nav>
      <button id="tab-feedback" class="tab active">í”¼ë“œë°± ì½”ë„ˆ</button>
      <button id="tab-final" class="tab">ìµœì¢… ì‚°ì¶œë¬¼ ì½”ë„ˆ</button>
    </nav>

    <!-- í”¼ë“œë°± ì½”ë„ˆ -->
    <section id="feedback-section" class="section active">
      <form id="feedback-form">
        <label>ì˜ì‘í•œ ë‚´ìš©ì„ ì…ë ¥í•˜ê³  í”¼ë“œë°±ì„ ë°›ì•„ ìˆ˜ì •í•´ë³´ì„¸ìš”!</label>
        <div class="action-icons">
          <button type="button" class="icon-btn" title="ì‚¬ì§„ ì´¬ì˜">
            ğŸ“·
            <input type="file" id="contentFile-camera-feedback" accept="image/*" capture="environment"/>
          </button>
          <button type="button" class="icon-btn" title="ì´ë¯¸ì§€ ì„ íƒ">
            ğŸ–¼ï¸
            <input type="file" id="contentFile-gallery-feedback" accept="image/*"/>
          </button>
        </div>
        <div class="input-container">
          <textarea 
            id="contentText-feedback" 
            class="input-area" 
            placeholder="ì—¬ê¸°ì— í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ìœ„ì˜ ì•„ì´ì½˜ì„ í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”"
          ></textarea>
        </div>
        <div class="file-info" id="file-info-feedback">
          <span class="file-name"></span>
          <button type="button" class="remove-file">Ã—</button>
        </div>
        <div class="ocr-status" id="ocr-status-feedback">
          <div class="spinner" style="display: inline-block; border: 2px solid #856404; border-top: 2px solid transparent;"></div>
          <span>ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤...</span>
        </div>
        <button type="submit" id="submit-feedback-btn">
          Get Feedback<span id="submit-spinner-feedback" class="spinner"></span>
        </button>
      </form>
      <div id="feedback-result"></div>
    </section>

    <!-- ìµœì¢… ì‚°ì¶œë¬¼ ì½”ë„ˆ -->
    <section id="final-section" class="section">
      <form id="final-form">
        <label>í”¼ë“œë°±ì„ ë°›ì•„ ì™„ì„±í•œ ë‚´ìš©ì„ ì…ë ¥í•˜ê³  ìµœì¢… ê²°ê³¼ë¬¼ì„ ì¶œë ¥í•´ë³´ì„¸ìš”!</label>
        <div class="action-icons">
          <button type="button" class="icon-btn" title="ì‚¬ì§„ ì´¬ì˜">
            ğŸ“·
            <input type="file" id="contentFile-camera-final" accept="image/*" capture="environment"/>
          </button>
          <button type="button" class="icon-btn" title="ì´ë¯¸ì§€ ì„ íƒ">
            ğŸ–¼ï¸
            <input type="file" id="contentFile-gallery-final" accept="image/*"/>
          </button>
        </div>
        <div class="input-container">
          <textarea 
            id="contentText-final" 
            class="input-area" 
            placeholder="ì—¬ê¸°ì— í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ìœ„ì˜ ì•„ì´ì½˜ì„ í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”"
          ></textarea>
        </div>
        <div class="file-info" id="file-info-final">
          <span class="file-name"></span>
          <button type="button" class="remove-file">Ã—</button>
        </div>
        <div class="ocr-status" id="ocr-status-final">
          <div class="spinner" style="display: inline-block; border: 2px solid #856404; border-top: 2px solid transparent;"></div>
          <span>ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤...</span>
        </div>
        <button type="submit" id="submit-final-btn">
          Generate Final<span id="submit-spinner-final" class="spinner"></span>
        </button>
      </form>
      <div id="final-result"></div>
    </section>
  </div>

  <script>
    const WORKER_URL = 'https://writing-feedback-app.sehyunglee2015.workers.dev';
    const PROXY_URL  = WORKER_URL + '/proxy';

    // Reset ë²„íŠ¼ ê¸°ëŠ¥
    document.getElementById('reset-btn').onclick = () => {
      document.getElementById('contentText-feedback').value = '';
      document.getElementById('contentText-final').value = '';
      document.getElementById('feedback-result').innerHTML = '';
      document.getElementById('final-result').innerHTML = '';
      resetFileInputs('feedback');
      resetFileInputs('final');
    };

    function resetFileInputs(section) {
      const cameraInput = document.getElementById(`contentFile-camera-${section}`);
      const galleryInput = document.getElementById(`contentFile-gallery-${section}`);
      const fileInfo = document.getElementById(`file-info-${section}`);
      const ocrStatus = document.getElementById(`ocr-status-${section}`);
      const textArea = document.getElementById(`contentText-${section}`);
      
      if (cameraInput) cameraInput.value = '';
      if (galleryInput) galleryInput.value = '';
      if (fileInfo) fileInfo.classList.remove('show');
      if (ocrStatus) ocrStatus.classList.remove('show');
      if (textArea) textArea.classList.remove('has-image');
    }

    // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
    function setupFileHandling(section) {
      const cameraInput = document.getElementById(`contentFile-camera-${section}`);
      const galleryInput = document.getElementById(`contentFile-gallery-${section}`);
      const fileInfo = document.getElementById(`file-info-${section}`);
      const removeBtn = fileInfo.querySelector('.remove-file');
      const textArea = document.getElementById(`contentText-${section}`);
      
      function handleFileSelect(file) {
        if (file) {
          showFileInfo(file, fileInfo);
          textArea.classList.add('has-image');
          handleOCR(file, section);
        }
      }
      
      cameraInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleFileSelect(e.target.files[0]);
        }
      });
      
      galleryInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleFileSelect(e.target.files[0]);
        }
      });
      
      removeBtn.addEventListener('click', () => {
        resetFileInputs(section);
      });
    }
    
    function showFileInfo(file, fileInfo) {
      fileInfo.querySelector('.file-name').textContent = file.name;
      fileInfo.classList.add('show');
    }
    
    setupFileHandling('feedback');
    setupFileHandling('final');

    // íƒ­ ì „í™˜
    const tabFb = document.getElementById('tab-feedback');
    const tabFn = document.getElementById('tab-final');
    const secFb = document.getElementById('feedback-section');
    const secFn = document.getElementById('final-section');
    
    tabFb.onclick = () => {
      tabFb.classList.add('active'); tabFn.classList.remove('active');
      secFb.classList.add('active'); secFn.classList.remove('active');
    };
    tabFn.onclick = () => {
      tabFn.classList.add('active'); tabFb.classList.remove('active');
      secFn.classList.add('active'); secFb.classList.remove('active');
    };

    // OCR ì²˜ë¦¬
    async function handleOCR(file, section) {
      const textArea = document.getElementById(`contentText-${section}`);
      const ocrStatus = document.getElementById(`ocr-status-${section}`);
      
      ocrStatus.classList.add('show');
      
      try {
        const b64 = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
        
        const response = await fetch(PROXY_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [{
              role: 'user',
              content: [
                { type: 'text', text: 'Please extract the exact text from the image as it appears. Do not provide any additional commentary.' },
                { type: 'image_url', image_url: { url: `data:${file.type};base64,${b64}` } }
              ]
            }],
            max_tokens: 500
          })
        });
        
        const { choices } = await response.json();
        const extractedText = choices[0]?.message?.content?.trim() || '';
        
        if (extractedText) {
          textArea.value = extractedText;
        } else {
          throw new Error('í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('OCR ì—ëŸ¬:', error);
        textArea.value = `OCR ì—ëŸ¬: ${error.message}`;
      } finally {
        ocrStatus.classList.remove('show');
      }
    }

    // í”¼ë“œë°± ì½”ë„ˆ ì œì¶œ
    document.getElementById('feedback-form').onsubmit = async e => {
      e.preventDefault();
      const btn = document.getElementById('submit-feedback-btn');
      const sp = document.getElementById('submit-spinner-feedback');
      btn.disabled = true;
      sp.style.display = 'inline-block';

      const content = document.getElementById('contentText-feedback').value;
      
      try {
        const res = await fetch(`${WORKER_URL}/api/feedback`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contentText: content })
        });
        
        const { feedback, modelAnswer } = await res.json();
        
        document.getElementById('feedback-result').innerHTML = `
          <div class="box" id="fb-box">
            <h2>Feedback</h2>
            <div id="fb-content">${feedback.replace(/\n/g,'<br>')}</div>
            <button id="edit-feedback-btn">Edit Feedback</button>
          </div>
          <div class="box">
            <h2>ìˆ˜ì •ê¸€</h2>
            <div class="model-box" id="fb-corrected">${modelAnswer.replace(/\n/g,'<br>')}</div>
          </div>
          <div class="print-options">
            <label><input type="checkbox" id="print_orig_fb" checked> ì›ë³¸</label>
            <label><input type="checkbox" id="print_fb_fb" checked> í”¼ë“œë°±</label>
            <label><input type="checkbox" id="print_corr_fb" checked> ìˆ˜ì •ê¸€</label>
          </div>
          <button id="print-feedback-btn">Print</button>
        `;

        setupEditFunctionality('feedback');
        setupPrintFunctionality('feedback');
      } catch (error) {
        console.error('í”¼ë“œë°± ìš”ì²­ ì—ëŸ¬:', error);
        alert('í”¼ë“œë°± ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      } finally {
        btn.disabled = false;
        sp.style.display = 'none';
      }
    };

    // ìµœì¢… ì‚°ì¶œë¬¼ ì½”ë„ˆ ì œì¶œ
    let lastFeedback = '';
    document.getElementById('final-form').onsubmit = async e => {
      e.preventDefault();
      const btn = document.getElementById('submit-final-btn');
      const sp = document.getElementById('submit-spinner-final');
      btn.disabled = true;
      sp.style.display = 'inline-block';

      const content = document.getElementById('contentText-final').value;
      
      try {
        const res = await fetch(`${WORKER_URL}/api/feedback`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contentText: content })
        });
        
        const { feedback, modelAnswer } = await res.json();
        lastFeedback = feedback;

        document.getElementById('final-result').innerHTML = `
          <div class="box" id="fn-box">
            <h2>ìˆ˜ì •ê¸€</h2>
            <div class="model-box" id="fn-corrected">${modelAnswer.replace(/\n/g,'<br>')}</div>
            <button id="edit-final-btn">Edit Final</button>
          </div>
          <button id="tts-btn">ì›ì–´ë¯¼ ìŒì„± ë“£ê¸°<span id="tts-spinner" class="spinner"></span></button>
          <audio id="tts-audio" controls style="display:none;"></audio>
          <a id="download-link">Download Audio</a>
          <div class="print-options">
            <label><input type="checkbox" id="print_orig_fn" checked> ì›ë³¸</label>
            <label><input type="checkbox" id="print_fb_fn"> í”¼ë“œë°±</label>
            <label><input type="checkbox" id="print_corr_fn" checked> ìˆ˜ì •ê¸€</label>
          </div>
          <button id="print-model-btn">Print</button>
        `;

        setupEditFunctionality('final');
        setupTTSFunctionality();
        setupPrintFunctionality('final');
      } catch (error) {
        console.error('ìµœì¢… ì‚°ì¶œë¬¼ ìš”ì²­ ì—ëŸ¬:', error);
        alert('ìµœì¢… ì‚°ì¶œë¬¼ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      } finally {
        btn.disabled = false;
        sp.style.display = 'none';
      }
    };

    // í¸ì§‘ ê¸°ëŠ¥ ì„¤ì •
    function setupEditFunctionality(type) {
      const btnId = type === 'feedback' ? 'edit-feedback-btn' : 'edit-final-btn';
      const contentId = type === 'feedback' ? 'fb-content' : 'fn-corrected';
      const editId = type === 'feedback' ? 'fb-edit' : 'fn-edit';
      
      document.getElementById(btnId).onclick = function() {
        try {
          const ta = document.getElementById(editId);
          if (ta && ta.tagName) {
            // Save mode
            const newDiv = document.createElement('div');
            if (type === 'final') newDiv.className = 'model-box';
            newDiv.id = contentId;
            newDiv.innerHTML = ta.value.replace(/\n/g,'<br>');
            ta.replaceWith(newDiv);
            this.textContent = type === 'feedback' ? 'Edit Feedback' : 'Edit Final';
          } else {
            // Edit mode
            const d = document.getElementById(contentId);
            if (d && d.tagName) {
              const textarea = document.createElement('textarea');
              textarea.id = editId;
              textarea.style.width = '100%';
              textarea.style.height = '150px';
              textarea.style.boxSizing = 'border-box';
              textarea.value = d.innerText || d.textContent || '';
              d.replaceWith(textarea);
              this.textContent = 'Save';
            }
          }
        } catch(err) {
          console.error('Edit error:', err);
        }
      };
    }

    // TTS ê¸°ëŠ¥ ì„¤ì •
    function setupTTSFunctionality() {
      document.getElementById('tts-btn').onclick = async () => {
        const tbtn = document.getElementById('tts-btn');
        const tsp = document.getElementById('tts-spinner');
        const dl = document.getElementById('download-link');
        const au = document.getElementById('tts-audio');
        
        tbtn.disabled = true;
        tsp.style.display = 'inline-block';
        if (dl) dl.style.display = 'none';
        
        try {
          const correctedElement = document.getElementById('fn-corrected');
          if (!correctedElement) {
            throw new Error('ìˆ˜ì •ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          }
          
          const txt = correctedElement.innerText || correctedElement.textContent || '';
          if (!txt.trim()) {
            throw new Error('ìˆ˜ì •ê¸€ ë‚´ìš©ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
          }
          
          const response = await fetch(`${WORKER_URL}/api/tts`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: txt })
          });
          
          if (!response.ok) {
            throw new Error(`TTS API ì˜¤ë¥˜: ${response.status}`);
          }
          
          const blob = await response.blob();
          const url = URL.createObjectURL(blob);
          
          if (au) {
            au.src = url;
            au.style.display = 'block';
          }
          if (dl) {
            dl.href = url;
            dl.download = 'model-answer.mp3';
            dl.style.display = 'block';
          }
        } catch(error) {
          console.error('TTS error:', error);
          alert('TTS ì—ëŸ¬: ' + error.message);
        } finally {
          tsp.style.display = 'none';
          tbtn.disabled = false;
        }
      };
    }

    // ì¸ì‡„ ê¸°ëŠ¥ ì„¤ì •
    function setupPrintFunctionality(type) {
      const btnId = type === 'feedback' ? 'print-feedback-btn' : 'print-model-btn';
      const textAreaId = type === 'feedback' ? 'contentText-feedback' : 'contentText-final';
      const correctedId = type === 'feedback' ? 'fb-corrected' : 'fn-corrected';
      const fbContentId = type === 'feedback' ? 'fb-content' : null;
      
      document.getElementById(btnId).onclick = () => {
        const origCheck = document.getElementById(`print_orig_${type === 'feedback' ? 'fb' : 'fn'}`);
        const fbCheck = document.getElementById(`print_fb_${type === 'feedback' ? 'fb' : 'fn'}`);
        const corrCheck = document.getElementById(`print_corr_${type === 'feedback' ? 'fb' : 'fn'}`);
        
        let html = '<!doctype html><html><head><meta charset="utf-8"/><title>Print</title>'
                 + '<style>body{font-family:sans-serif;padding:2rem;}@media print{button{display:none}}</style></head><body>';
        
        if (origCheck && origCheck.checked) {
          html += `<h2>ì›ë³¸</h2><pre>${document.getElementById(textAreaId).value}</pre>`;
        }
        
        if (fbCheck && fbCheck.checked) {
          if (type === 'feedback' && fbContentId) {
            const fbContent = document.getElementById(fbContentId);
            if (fbContent) html += `<h2>Feedback</h2>${fbContent.outerHTML}`;
          } else if (type === 'final') {
            html += `<h2>Feedback</h2>${lastFeedback.replace(/\n/g,'<br>')}`;
          }
        }
        
        if (corrCheck && corrCheck.checked) {
          const corrected = document.getElementById(correctedId);
          if (corrected) html += `<h2>ìˆ˜ì •ê¸€</h2>${corrected.outerHTML}`;
        }
        
        html += '<script>window.print();window.onafterprint=()=>window.close();<\/script></body></html>';
        const w = window.open();
        w.document.write(html);
        w.document.close();
      };
    }
  </script>
</body>
</html>
