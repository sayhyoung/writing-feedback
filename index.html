<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Writing Assistant</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="font-sans bg-gray-100 p-8 flex justify-center leading-relaxed">
  <div id="container" class="w-full max-w-[700px] bg-white rounded-lg shadow-md p-8 relative">
    <h1 class="text-center text-blue-700 mb-4">ğŸ¤– Writing Assistant</h1>
    <button id="reset-btn" class="absolute top-8 right-8 bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2 transition">Reset</button>

    <nav class="text-center mb-4">
      <button id="tab-feedback" class="tab bg-blue-600 text-white px-4 py-2 mx-2 rounded font-bold transition-colors duration-200">í”¼ë“œë°± ì½”ë„ˆ</button>
      <button id="tab-final" class="tab bg-blue-100 text-blue-700 hover:bg-blue-200 px-4 py-2 mx-2 rounded font-bold transition-colors duration-200">ìµœì¢… ì‚°ì¶œë¬¼ ì½”ë„ˆ</button>
    </nav>

    <!-- í”¼ë“œë°± ì„¹ì…˜ -->
    <section id="feedback-section" class="block">
      <form id="feedback-form">
        <label class="block mb-2">ì˜ì‘ ë‚´ìš©ì„ ì…ë ¥í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</label>
        <div class="action-icons flex justify-end gap-2 mb-2">
          <button type="button" class="icon-btn w-8 h-8 bg-white shadow rounded flex items-center justify-center transition hover:bg-gray-100" title="ì‚¬ì§„ ì´¬ì˜">ğŸ“·
            <input type="file" id="contentFile-camera-feedback" accept="image/*" capture="environment" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
          </button>
          <button type="button" class="icon-btn w-8 h-8 bg-white shadow rounded flex items-center justify-center transition hover:bg-gray-100" title="ì´ë¯¸ì§€ ì„ íƒ">ğŸ–¼ï¸
            <input type="file" id="contentFile-gallery-feedback" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
          </button>
        </div>
        <textarea id="contentText-feedback" class="input-area w-full min-h-[150px] p-4 border-2 border-gray-300 rounded-lg bg-blue-50 resize-y focus:outline-none focus:border-blue-600 text-base leading-relaxed" placeholder="ì—¬ê¸°ì— í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
        <div class="file-info hidden mt-2 p-2 bg-blue-100 rounded text-sm" id="file-info-feedback"><span class="file-name text-blue-700 font-medium"></span></div>
        <div class="ocr-status hidden mt-2 p-2 bg-yellow-100 border border-yellow-300 rounded text-yellow-700 flex items-center gap-2" id="ocr-status-feedback">
          <div class="spinner w-4 h-4 border-2 border-yellow-700 border-t-transparent rounded-full animate-spin"></div>
          <span>ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œ ì¤‘ì…ë‹ˆë‹¤...</span>
        </div>
        <button type="submit" id="submit-feedback-btn" class="bg-blue-600 hover:bg-blue-700 text-white rounded px-6 py-3 mt-4 transition flex items-center">
          Get Feedback
          <span id="submit-spinner-feedback" class="spinner hidden w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin ml-2"></span>
        </button>
      </form>

      <div id="feedback-result"></div>

      <!-- Print ì˜µì…˜ ëª¨ë‹¬ -->
      <div id="feedback-print-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
        <div class="modal-content bg-white p-4 rounded w-11/12 max-w-sm">
          <h3 class="text-blue-700 text-lg mb-3">Print Options</h3>
          <div class="print-options mb-4">
            <label class="block mb-1"><input type="checkbox" id="print_orig_fb" checked class="mr-2"> ì›ë³¸</label>
            <label class="block mb-1"><input type="checkbox" id="print_fb_fb" checked class="mr-2"> í”¼ë“œë°±</label>
            <label class="block mb-1"><input type="checkbox" id="print_corr_fb" checked class="mr-2"> ìˆ˜ì •ê¸€</label>
          </div>
          <button id="confirm-print-feedback-btn" class="bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2 mr-2 transition">Confirm</button>
          <button id="cancel-print-feedback-btn" class="bg-gray-400 hover:bg-gray-500 text-white rounded px-4 py-2 transition">Cancel</button>
        </div>
      </div>
    </section>

    <!-- ìµœì¢… ì‚°ì¶œë¬¼ ì„¹ì…˜ -->
    <section id="final-section" class="hidden">
      <form id="final-form">
        <label class="block mb-2">ìµœì¢… ê²°ê³¼ë¬¼ì„ ìœ„í•´ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</label>
        <div class="action-icons flex justify-end gap-2 mb-2">
          <button type="button" class="icon-btn w-8 h-8 bg-white shadow rounded flex items-center justify-center transition hover:bg-gray-100" title="ì‚¬ì§„ ì´¬ì˜">ğŸ“·
            <input type="file" id="contentFile-camera-final" accept="image/*" capture="environment" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
          </button>
          <button type="button" class="icon-btn w-8 h-8 bg-white shadow rounded flex items-center justify-center transition hover:bg-gray-100" title="ì´ë¯¸ì§€ ì„ íƒ">ğŸ–¼ï¸
            <input type="file" id="contentFile-gallery-final" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
          </button>
        </div>
        <textarea id="contentText-final" class="input-area w-full min-h-[150px] p-4 border-2 border-gray-300 rounded-lg bg-blue-50 resize-y focus:outline-none focus:border-blue-600 text-base leading-relaxed" placeholder="ì—¬ê¸°ì— í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
        <div class="file-info hidden mt-2 p-2 bg-blue-100 rounded text-sm" id="file-info-final"><span class="file-name text-blue-700 font-medium"></span></div>
        <div class="ocr-status hidden mt-2 p-2 bg-yellow-100 border border-yellow-300 rounded text-yellow-700 flex items-center gap-2" id="ocr-status-final">
          <div class="spinner w-4 h-4 border-2 border-yellow-700 border-t-transparent rounded-full animate-spin"></div>
          <span>ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œ ì¤‘ì…ë‹ˆë‹¤...</span>
        </div>
        <button type="submit" id="submit-final-btn" class="bg-blue-600 hover:bg-blue-700 text-white rounded px-6 py-3 mt-4 transition flex items-center">
          Generate Final
          <span id="submit-spinner-final" class="spinner hidden w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin ml-2"></span>
        </button>
      </form>

      <div id="final-result"></div>

      <!-- Print ì˜µì…˜ ëª¨ë‹¬ -->
      <div id="final-print-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
        <div class="modal-content bg-white p-4 rounded w-11/12 max-w-sm">
          <h3 class="text-blue-700 text-lg mb-3">Print Options</h3>
          <div class="print-options mb-4">
            <label class="block mb-1"><input type="checkbox" id="print_orig_fn" checked class="mr-2"> ì›ë³¸</label>
            <label class="block mb-1"><input type="checkbox" id="print_fb_fn" class="mr-2"> í”¼ë“œë°±</label>
            <label class="block mb-1"><input type="checkbox" id="print_corr_fn" checked class="mr-2"> ìˆ˜ì •ê¸€</label>
          </div>
          <button id="confirm-print-final-btn" class="bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2 mr-2 transition">Confirm</button>
          <button id="cancel-print-final-btn" class="bg-gray-400 hover:bg-gray-500 text-white rounded px-4 py-2 transition">Cancel</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    const WORKER_URL = 'https://writing-feedback-app.sehyunglee2015.workers.dev';
    const PROXY_URL  = WORKER_URL + '/proxy';
    // íŒŒì¼ URL ì €ì¥ìš©
    window.feedbackFileURL = '';
    window.finalFileURL    = '';
    // Reset ë²„íŠ¼
    document.getElementById('reset-btn').onclick = () => {
      ['feedback','final'].forEach(sec => {
        document.getElementById(`contentText-${sec}`).value = '';
        document.getElementById(`file-info-${sec}`).classList.add('hidden');
        document.getElementById(`ocr-status-${sec}`).classList.add('hidden');
        document.getElementById(`contentText-${sec}`).classList.remove('has-image');
        if (window[`${sec}FileURL`]) window[`${sec}FileURL`] = '';
        document.getElementById(`${sec}-result`).innerHTML = '';
      });
    };
    // íƒ­ ì „í™˜
    document.getElementById('tab-feedback').onclick = () => {
      document.getElementById('feedback-section').classList.remove('hidden');
      document.getElementById('tab-feedback').classList.replace('bg-blue-100', 'bg-blue-600');
      document.getElementById('tab-feedback').classList.replace('text-blue-700', 'text-white');
      document.getElementById('final-section').classList.add('hidden');
      document.getElementById('tab-final').classList.replace('bg-blue-600', 'bg-blue-100');
      document.getElementById('tab-final').classList.replace('text-white', 'text-blue-700');
    };
    document.getElementById('tab-final').onclick = () => {
      document.getElementById('final-section').classList.remove('hidden');
      document.getElementById('tab-final').classList.replace('bg-blue-100', 'bg-blue-600');
      document.getElementById('tab-final').classList.replace('text-blue-700', 'text-white');
      document.getElementById('feedback-section').classList.add('hidden');
      document.getElementById('tab-feedback').classList.replace('bg-blue-600', 'bg-blue-100');
      document.getElementById('tab-feedback').classList.replace('text-white', 'text-blue-700');
    };
    // íŒŒì¼ ì—…ë¡œë“œ ì„¸íŒ…
    ['feedback','final'].forEach(section => {
      ['camera','gallery'].forEach(src => {
        const input = document.getElementById(`contentFile-${src}-${section}`);
        input.addEventListener('change', e => {
          const file = e.target.files[0];
          if (!file) return;
          // ì›ë³¸ ì´ë¯¸ì§€ URL ì €ì¥
          const url = URL.createObjectURL(file);
          window[`${section}FileURL`] = url;
          // íŒŒì¼ ì •ë³´ í‘œì‹œ
          const info = document.getElementById(`file-info-${section}`);
          info.querySelector('.file-name').textContent = file.name;
          info.classList.remove('hidden');
          // í…ìŠ¤íŠ¸ ì˜ì—­ì— has-image í´ë˜ìŠ¤
          document.getElementById(`contentText-${section}`).classList.add('has-image');
          // OCR ìˆ˜í–‰
          doOCR(file, section);
        });
      });
    });
    // OCR ìš”ì²­
    async function doOCR(file, section) {
      const status = document.getElementById(`ocr-status-${section}`);
      status.classList.remove('hidden');
      try {
        const b64 = await new Promise((res, rej) => {
          const reader = new FileReader();
          reader.onload = () => res(reader.result.split(',')[1]);
          reader.onerror = rej;
          reader.readAsDataURL(file);
        });
        const resp = await fetch(PROXY_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [{
              role: 'user',
              content: [
                { type: 'text', text: 'Please extract the exact text from the image as it appears. Do not provide any additional commentary.' },
                { type: 'image_url', image_url: { url: `data:${file.type};base64,${b64}` } }
              ]
            }]
          })
        });
        const { choices } = await resp.json();
        document.getElementById(`contentText-${section}`).value = (choices[0]?.message?.content || '').trim();
      } catch(err) {
        document.getElementById(`contentText-${section}`).value = 'OCR ì—ëŸ¬: ' + err.message;
      } finally {
        status.classList.add('hidden');
      }
    }
    // Print ëª¨ë‹¬ ë°”ì¸ë”© í•¨ìˆ˜
    function bindPrintModal(section) {
      const modal = document.getElementById(`${section}-print-modal`);
      const btnOpen  = section === 'feedback'
        ? document.getElementById('print-feedback-btn')
        : document.getElementById('print-model-btn');
      const btnCancel  = document.getElementById(`cancel-print-${section}-btn`);
      const btnConfirm = document.getElementById(`confirm-print-${section}-btn`);

      btnOpen?.addEventListener('click', () => modal.classList.remove('hidden'));
      btnCancel?.addEventListener('click', () => modal.classList.add('hidden'));

      btnConfirm?.addEventListener('click', () => {
        const orig = document.getElementById(`print_orig_${section==='feedback'?'fb':'fn'}`).checked;
        const fb   = document.getElementById(`print_fb_${section==='feedback'?'fb':'fn'}`).checked;
        const corr = document.getElementById(`print_corr_${section==='feedback'?'fb':'fn'}`).checked;

        let html = `<!doctype html><html><head><meta charset="utf-8"/>
          <title>Print</title>
          <style>body{font-family:sans-serif;padding:2rem;}@media print{button{display:none}}</style>
        </head><body>`;

        if (orig) {
          html += '<h2>ì›ë³¸</h2>';
          if (window[`${section}FileURL`]) {
            html += `<img src="${window[`${section}FileURL`]" style="max-width:100%;"/>`;
          } else {
            html += `<pre>${document.getElementById(`contentText-${section}`).value}</pre>`;
          }
        }
        if (fb) {
          if (section === 'feedback') {
            html += '<h2>Feedback</h2>' + document.getElementById('fb-content').outerHTML;
          } else {
            html += '<h2>Feedback</h2>' + lastFeedback.replace(/\n/g,'<br>');
          }
        }
        if (corr) {
          html += '<h2>ìˆ˜ì •ê¸€</h2>' + document.getElementById(section==='feedback'?'fb-corrected':'fn-corrected').outerHTML;
        }

        html += `<script>window.print();window.onafterprint=()=>window.close();<\/script></body></html>`;
        const win = window.open();
        win.document.write(html);
        win.document.close();
        modal.classList.add('hidden');
      });
    }
    // Feedback ì œì¶œ
    document.getElementById('feedback-form').addEventListener('submit', async e => {
      e.preventDefault();
      const btn = document.getElementById('submit-feedback-btn');
      const sp  = document.getElementById('submit-spinner-feedback');
      btn.disabled = true; sp.classList.remove('hidden');

      const text = document.getElementById('contentText-feedback').value;
      try {
        const res = await fetch(`${WORKER_URL}/api/feedback`, {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ contentText: text })
        });
        const { feedback, modelAnswer } = await res.json();
        lastFeedback = feedback;
        document.getElementById('feedback-result').innerHTML = `
          <div class="box mt-4 bg-white rounded-md p-4 shadow">
            <h2 class="text-blue-700 text-lg mb-2">Feedback</h2>
            <div id="fb-content" class="prose">${feedback.replace(/\n/g,'<br>')}</div>
            <button id="print-feedback-btn" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2 transition">Print</button>
          </div>
          <div class="box mt-4 bg-white rounded-md p-4 shadow">
            <h2 class="text-blue-700 text-lg mb-2">ìˆ˜ì •ê¸€</h2>
            <div class="model-box prose text-base leading-relaxed" id="fb-corrected">${modelAnswer.replace(/\n/g,'<br>')}</div>
          </div>`;
        bindPrintModal('feedback');
      } catch(err) {
        alert('í”¼ë“œë°± ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      } finally {
        btn.disabled = false; sp.classList.add('hidden');
      }
    });

    // Final ì œì¶œ
    let lastFeedback = '';
    document.getElementById('final-form').addEventListener('submit', async e => {
      e.preventDefault();
      const btn = document.getElementById('submit-final-btn');
      const sp  = document.getElementById('submit-spinner-final');
      btn.disabled = true; sp.classList.remove('hidden');

      const text = document.getElementById('contentText-final').value;
      try {
        const res = await fetch(`${WORKER_URL}/api/feedback`, {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ contentText: text })
        });
        const { feedback, modelAnswer } = await res.json();
        lastFeedback = feedback;
        document.getElementById('final-result').innerHTML = `
          <div class="box mt-4 bg-white rounded-md p-4 shadow">
            <h2 class="text-blue-700 text-lg mb-2">ìˆ˜ì •ê¸€</h2>
            <div class="model-box prose text-base leading-relaxed" id="fn-corrected">${modelAnswer.replace(/\n/g,'<br>')}</div>
            <button id="print-model-btn" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2 transition">Print</button>
          </div>`;
        bindPrintModal('final');
      } catch(err) {
        alert('ìµœì¢… ê²°ê³¼ë¬¼ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      } finally {
        btn.disabled = false; sp.classList.add('hidden');
      }
    });
  </script>
</body>
</html>
