export default {
  async fetch(request, env) {
    const url = new URL(request.url);

    // CORS preflight
    if (request.method === 'OPTIONS') {
      return new Response(null, {
        status: 204,
        headers: {
          'Access-Control-Allow-Origin': '*',
          'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
          'Access-Control-Allow-Headers': 'Content-Type',
        },
      });
    }

    // 1) Feedback endpoint
    if (url.pathname === '/api/feedback' && request.method === 'POST') {
      const { contentText } = await request.json();
      const systemPrompt = `
친절한 영어 교사입니다. 학생이 제출한 글을 아래 두 부분으로 평가하세요.

1) 피드백 (한국어)
  - 먼저 “총평”을 제시하세요.
  - 그 아래 개별 문장 단위로 피드백을 아래 예시와 같이 작성하세요.
  예시 1)
  I go to hospital yesterday.
  - 과거에 일어난 일이므로 “go” 대신 과거형 “went” 사용해야 하며, “hospital” 앞에 관사 “the”를 붙여야 합니다.

  예시 2)
  I want play with him.
  - 동사 앞에 “to” 누락되어 “want to play” 형태로 수정이 필요합니다.

2) 수정글
  - 학생이 제출한 글을 바탕으로, 피드백을 반영하여 수정한 글을 작성하세요.

JSON으로만 응답:
{"feedback":"...","modelAnswer":"..."}
`;
      const userPrompt = `Content: ${contentText}`;
      const aiRes = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${env.OPENAI_API_KEY}`,
        },
        body: JSON.stringify({
          model: 'gpt-4o-mini',
          messages: [
            { role: 'system', content: systemPrompt },
            { role: 'user',   content: userPrompt },
          ],
          temperature: 0.7,
        }),
      });
      const data = await aiRes.json();
      let parsed;
      try {
        parsed = JSON.parse(data.choices[0].message.content);
      } catch {
        parsed = { feedback: data.choices[0].message.content, modelAnswer: '' };
      }
      return new Response(JSON.stringify(parsed), {
        headers: {
          'Content-Type': 'application/json',
          'Access-Control-Allow-Origin': '*',
        },
      });
    }

    // 2) TTS endpoint
    if (url.pathname === '/api/tts' && request.method === 'POST') {
      const { text } = await request.json();
      const ttsRes = await fetch('https://api.openai.com/v1/audio/speech', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${env.OPENAI_API_KEY}`,
        },
        body: JSON.stringify({ model: 'tts-1', voice: 'alloy', input: text }),
      });
      const buffer = await ttsRes.arrayBuffer();
      return new Response(buffer, {
        headers: {
          'Content-Type': 'audio/mpeg',
          'Access-Control-Allow-Origin': '*',
        },
      });
    }

    // 3) OCR proxy
    if (url.pathname === '/proxy' && request.method === 'POST') {
      const proxyRes = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${env.OPENAI_API_KEY}`,
        },
        body: await request.text(),
      });
      const body = await proxyRes.text();
      return new Response(body, {
        status: proxyRes.status,
        headers: {
          'Content-Type': proxyRes.headers.get('Content-Type'),
          'Access-Control-Allow-Origin': '*',
        },
      });
    }

    return new Response('Not found', { status: 404 });
  },
};
