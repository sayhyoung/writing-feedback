<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Writing Assistant</title>
  <style>
    /* Base & Layout */
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background-color: #f0f4f8;
      color: #1a1a1a;
      margin: 0;
      padding: 2rem;
      display: flex;
      justify-content: center;
      line-height: 1.6;
    }
    #container {
      width: 100%;
      max-width: 700px;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 2rem;
      position: relative;
    }
    h1 {
      color: #004a99;
      text-align: center;
      margin-bottom: 0.5rem;
    }

    /* Reset button under heading, right-aligned */
    #reset-btn {
      background-color: #ffffff;
      color: #0066cc;
      border: 1px solid #0066cc;
      border-radius: 4px;
      padding: 0.5rem 1rem;
      cursor: pointer;
      display: block;
      margin: 0 0 1rem auto;
      transition: background-color 0.2s ease;
    }
    #reset-btn:hover {
      background-color: #e9f5ff;
    }

    /* Navigation */
    #main-nav {
      display: flex;
      justify-content: center;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid #ddd;
    }
    #main-nav a {
      padding: 0.75rem 1.5rem;
      text-decoration: none;
      color: #004a99;
      font-weight: 600;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      transition: background-color 0.2s ease;
    }
    #main-nav a:hover {
      background-color: #e9f5ff;
    }
    #main-nav a.active {
      background-color: #0066cc;
      color: #ffffff;
      border-bottom: 3px solid #0066cc; /* Active tab indicator */
    }

    /* Page Content Sections */
    .page-content {
      display: none; /* Hidden by default, JS controls visibility */
    }
    .page-content.active {
      display: block;
    }

    /* Form */
    form {
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    label {
      display: block;
      margin: 0.75rem 0 0.25rem;
      font-weight: 600;
      color: #004a99;
    }
    input[type="text"],
    select,
    textarea,
    input[type="file"] {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #cbd7e0;
      border-radius: 4px;
      background: #f9fcff;
      font-size: 1rem;
      box-sizing: border-box;
    }
    textarea { resize: vertical; }

    /* Buttons */
    button {
      background-color: #0066cc;
      color: #ffffff;
      border: none;
      border-radius: 4px;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.2s ease;
      margin-top: 1rem;
    }
    button + button {
      margin-left: 0.5rem;
      margin-top: 1rem; /* Ensure vertical consistency */
    }
    button:hover {
      background-color: #0052a3;
    }
    .spinner {
      display: none;
      width: 16px;
      height: 16px;
      border: 2px solid #FF5722;
      border-top: 2px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      vertical-align: middle;
      margin-left: 0.5rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Result Boxes - Removed left border */
    .box {
      background: #e9f5ff;
      border-radius: 4px;
      padding: 1rem;
      margin-top: 1rem;
    }
    .model-box {
      background: #ffffff;
      padding: 1rem;
      border-radius: 4px;
      margin-top: 0.5rem;
      font-size: 1.1rem;
      line-height: 1.5;
    }

    /* Action controls spacing */
    .result-actions button,
    .result-actions a#download-link {
      display: inline-block;
      margin-top: 1.5rem;
      margin-right: 1rem;
    }
     .result-actions a#download-link { /* Ensure download link is correctly hidden */
         display: none;
     }
    .result-actions button:last-child,
    .result-actions a#download-link:last-child {
        margin-right: 0;
    }

    /* Ensure TTS and Print buttons have same height */
    #tts-btn-final-output,
    #print-btn-feedback,
    #print-btn-final-output { /* Apply to both print buttons */
        height: 2.5rem; /* ëª…ì‹œì ì¸ ë†’ì´ ì„¤ì • */
        box-sizing: border-box;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem 1.5rem; /* ê¸°ì¡´ íŒ¨ë”© ìœ ì§€ */
    }
     #tts-btn-final-output .spinner,
     #print-btn-feedback .spinner,
     #print-btn-final-output .spinner {
         flex-shrink: 0;
         margin-left: 0.5rem;
     }

    /* Hide download link until TTS completes */
    #download-link-final-output {
      display: none;
      color: #0066cc;
      text-decoration: none;
      font-weight: 600;
    }

     /* Print Options Modal */
    .print-options {
        margin-top: 1.5rem;
        padding: 1rem;
        border: 1px solid #cbd7e0;
        border-radius: 4px;
        background: #f9fcff;
        display: none; /* Hidden by default */
    }
    .print-options label {
        display: inline-block;
        margin-right: 1rem;
        font-weight: normal;
    }

    /* Editable content */
    .editable-content {
        padding: 0.5rem;
        border: 1px solid transparent; /* default state */
        border-radius: 4px;
        transition: border-color 0.2s ease;
        margin-top: 0.5rem;
    }
    .editable-content[contenteditable="true"] {
        border-color: #0066cc;
        background-color: #f0f8ff; /* Light blue background for editing */
    }
    .edit-btn, .save-btn {
        margin-top: 0.5rem; /* Adjust margin for edit/save buttons */
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
    }
    .edit-btn + .save-btn {
        margin-left: 0.5rem;
    }

    /* Print & Media - Original Template Styles */
    @media print {
      /* Hide all UI elements from main page */
      #main-nav, #submit-btn-feedback, #tts-btn-final-output, #print-btn-feedback, #print-btn-final-output, #reset-btn,
      .print-options, .edit-btn, .save-btn, #download-link-final-output,
      #feedback-form-feedback, #feedback-form-final-output,
      #result-feedback h2, #result-final-output h2, /* Hide result box titles in print */
      .box {
          display: none !important;
      }

      /* Show only print content */
      body { background: #ffffff; margin: 0; font-family: sans-serif; }
      #container {
          box-shadow: none;
          padding: 0;
          margin: 0;
          max-width: none;
          width: 100%;
      }

      /* Styles for the original print template structure */
      .print-header {
        text-align: center;
        margin-bottom: 1.5cm;
        margin-top: 0; /* ë¡œê³ ë¥¼ ìœ„ë¡œ ì˜¬ë¦¬ê¸° ìœ„í•´ ì¶”ê°€ */
      }
      .print-header img {
        max-height: 80px;
        margin-bottom: 0.5rem;
      }
      .print-header h2 {
        margin: 0;
        font-size: 1.4rem;
        color: #004a99;
      }
      .print-header p {
        margin-top: 0.5rem;
      }
      .print-section { /* ë©”ì¸ ë‚´ìš© ì„¹ì…˜ - ì›ë˜ í…œí”Œë¦¿ì˜ ì ì„  í…Œë‘ë¦¬ */
        margin-top: 1cm;
        padding: 1cm;
        border: 2px dashed #0066cc;
        min-height: 10cm; /* ì›ë˜ í…œí”Œë¦¿ì˜ ìµœì†Œ ë†’ì´ */
      }
       /* ë‚´ìš©ì´ ê¸¸ì–´ë„ ì²« í˜ì´ì§€ë¶€í„° ì‹œì‘ë˜ë„ë¡ sectionì˜ page-break-inside ì œê±° */
       header { page-break-inside: avoid; }
       section { page-break-inside: auto; } /* ì„¹ì…˜ ë‚´ì—ì„œ ìì—°ìŠ¤ëŸ½ê²Œ í˜ì´ì§€ ë‚˜ëˆ” í—ˆìš© */


       /* ê°œë³„ í”¼ë“œë°±/ìˆ˜ì •ê¸€ í•­ëª© ìŠ¤íƒ€ì¼ (ì„ íƒ ì‚¬í•­ì´ë‚˜ ìœ ì§€) */
        .print-content-item {
            margin-bottom: 1cm;
            padding-bottom: 1cm;
            border-bottom: 1px dashed #ccc;
            page-break-inside: avoid; /* Ensure item itself doesn't break */
       }
       .print-content-item:last-child {
           margin-bottom: 0;
           padding-bottom: 0;
           border-bottom: none;
       }
        .print-content-item h3 {
            color: #004a99;
            margin-top: 0;
        }

      /* Display the actual content for printing */
      #print-output-container {
          display: block !important;
          width: 100%;
      }
      /* Ensure original boxes and model box are not displayed in print */
      #feedback-box, #model-answer-container, #feedback-box-final-output, #model-answer-container-final-output {
          display: none !important;
      }
    }
  </style>
</head>
<body>
  <div id="container">
    <h1>ğŸ¤– Writing Assistant</h1>
    <button id="reset-btn">Reset</button>

    <nav id="main-nav">
      <a href="#" id="nav-feedback" class="active">í”¼ë“œë°± ì½”ë„ˆ</a>
      <a href="#" id="nav-final-output">ìµœì¢… ì‚°ì¶œë¬¼ ì½”ë„ˆ</a>
    </nav>

    <div id="feedback-corner-section" class="page-content active">
      <form id="feedback-form-feedback">
        <label>â‡ï¸ Text Content
          <textarea id="contentText-feedback" rows="8" placeholder="ì‘ì„±í•œ ê¸€ì„ ì—¬ê¸° ì˜®ê²¨ ì“°ê±°ë‚˜ ìº¡ì²˜í•´ì„œ ì˜¬ë ¤ì£¼ì„¸ìš”."></textarea>
        </label>
        <label>â‡ï¸ Image Upload (optional)
          <input type="file" id="contentFile-feedback" accept="image/*"/>
          <span id="ocr-spinner-feedback" class="spinner"></span>
        </label>
        <button type="submit" id="submit-btn-feedback">
          Submit<span id="submit-spinner-feedback" class="spinner"></span>
        </button>
      </form>

      <div id="result-feedback">
        <div class="box" id="feedback-box">
            <h2>Feedback</h2>
            <div id="feedback-content" class="editable-content" contenteditable="false"></div>
            <button class="edit-btn" data-target="feedback-content">í¸ì§‘</button>
            <button class="save-btn" data-target="feedback-content" style="display:none;">ì €ì¥</button>
        </div>
        <div class="box" id="model-answer-container-feedback">
          <h2>ìˆ˜ì •ê¸€</h2>
          <div class="model-box" id="model-answer-box-feedback" class="editable-content" contenteditable="false"></div>
        </div>
        <div class="result-actions">
            <button id="print-btn-feedback" type="button">Print</button>
            <div class="print-options" id="print-options-feedback">
                <label><input type="checkbox" id="print-original-feedback" checked> ì›ë³¸</label>
                <label><input type="checkbox" id="print-feedback-item" checked> Feedback</label>
                <label><input type="checkbox" id="print-model-answer-feedback" checked> ìˆ˜ì •ê¸€</label>
                <button id="confirm-print-btn-feedback">Confirm Print</button>
            </div>
        </div>
      </div>
    </div>

    <div id="final-output-corner-section" class="page-content">
      <form id="feedback-form-final-output">
        <label>â‡ï¸ Text Content
          <textarea id="contentText-final-output" rows="8" placeholder="ì‘ì„±í•œ ê¸€ì„ ì—¬ê¸° ì˜®ê²¨ ì“°ê±°ë‚˜ ìº¡ì²˜í•´ì„œ ì˜¬ë ¤ì£¼ì„¸ìš”."></textarea>
        </label>
        <label>â‡ï¸ Image Upload (optional)
          <input type="file" id="contentFile-final-output" accept="image/*"/>
          <span id="ocr-spinner-final-output" class="spinner"></span>
        </label>
        <button type="submit" id="submit-btn-final-output">
          Submit<span id="submit-spinner-final-output" class="spinner"></span>
        </button>
      </form>

      <div id="result-final-output">
        <div class="box" id="feedback-box-final-output" style="display:none;">
            <h2>Feedback</h2>
            <div id="feedback-content-final-output"></div>
        </div>
        <div class="box" id="model-answer-container-final-output">
          <h2>ìˆ˜ì •ê¸€</h2>
          <div class="model-box editable-content" id="model-answer-box-final-output" contenteditable="false"></div>
          <button class="edit-btn" data-target="model-answer-box-final-output">í¸ì§‘</button>
          <button class="save-btn" data-target="model-answer-box-final-output" style="display:none;">ì €ì¥</button>
        </div>
        <div class="result-actions">
            <button id="tts-btn-final-output">ì›ì–´ë¯¼ ìŒì„± ë“£ê¸°<span id="tts-spinner-final-output" class="spinner"></span></button>
            <audio id="tts-audio-final-output" controls style="display:none;"></audio>
            <a id="download-link-final-output">Download Audio</a>
            <button id="print-btn-final-output" type="button">Print</button>
            <div class="print-options" id="print-options-final-output">
                <label><input type="checkbox" id="print-original-final-output" checked> ì›ë³¸</label>
                <label><input type="checkbox" id="print-feedback-item-final-output" checked> Feedback</label>
                <label><input type="checkbox" id="print-model-answer-final-output" checked> ìˆ˜ì •ê¸€</label>
                <button id="confirm-print-btn-final-output">Confirm Print</button>
            </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const WORKER_URL = 'https://writing-feedback-app.sehyunglee2015.workers.dev';
    const PROXY_URL  = `${WORKER_URL}/proxy`;

    // --- Global State for Data (to share across pages and edits) ---
    const globalState = {
        originalText: {
            'feedback-corner': '',
            'final-output-corner': ''
        },
        feedback: {
            'feedback-corner': '',
            'final-output-corner': ''
        },
        modelAnswer: {
            'feedback-corner': '',
            'final-output-corner': ''
        },
        // Store the image URL if uploaded, for print
        originalImageUrl: {
            'feedback-corner': '',
            'final-output-corner': ''
        }
    };

    // --- Page Navigation ---
    const navFeedback = document.getElementById('nav-feedback');
    const navFinalOutput = document.getElementById('nav-final-output');
    const feedbackCornerSection = document.getElementById('feedback-corner-section');
    const finalOutputCornerSection = document.getElementById('final-output-corner-section');

    function showPage(pageId) {
        const allPages = document.querySelectorAll('.page-content');
        allPages.forEach(page => page.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');

        const allNavLinks = document.querySelectorAll('#main-nav a');
        allNavLinks.forEach(link => link.classList.remove('active'));
        document.getElementById(`nav-${pageId.replace('-section', '')}`).classList.add('active');

        // Reset the current page's form when switching, or hide results if no content
        // (Optional: can be left as is if you want results to persist when switching back)
        // document.getElementById('reset-btn').click(); // This would reset ALL
    }

    navFeedback.addEventListener('click', (e) => { e.preventDefault(); showPage('feedback-corner-section'); });
    navFinalOutput.addEventListener('click', (e) => { e.preventDefault(); showPage('final-output-corner-section'); });

    // --- Reset Button (resets current active form/results) ---
    document.getElementById('reset-btn').addEventListener('click', () => {
        const activePageId = document.querySelector('.page-content.active').id;
        const pageName = activePageId.replace('-corner-section', ''); // 'feedback' or 'final-output'

        // Reset Textareas and File Inputs
        document.getElementById(`contentText-${pageName}`).value = '';
        document.getElementById(`contentFile-${pageName}`).value = '';

        // Clear displayed results and hide result actions
        document.getElementById(`result-${pageName}`).innerHTML = '';

        // Clear global state for the current page
        globalState.originalText[pageName] = '';
        globalState.feedback[pageName] = '';
        globalState.modelAnswer[pageName] = '';
        globalState.originalImageUrl[pageName] = '';
    });

    // --- OCR Function (shared logic, adapted for page IDs) ---
    async function handleOCR(pageName) {
      const ta = document.getElementById(`contentText-${pageName}`);
      const fileInput = document.getElementById(`contentFile-${pageName}`);
      const spinner = document.getElementById(`ocr-spinner-${pageName}`);
      const file = fileInput.files[0];

      if (!file) return;

      ta.value = 'ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ ì¤‘...';
      spinner.style.display = 'inline-block';
      globalState.originalImageUrl[pageName] = ''; // Clear previous image URL

      const b64 = await new Promise((res, rej) => {
        const reader = new FileReader();
        reader.onload = () => {
            globalState.originalImageUrl[pageName] = `data:${file.type};base64,${reader.result.split(',')[1]}`;
            res(reader.result.split(',')[1]);
        };
        reader.onerror = rej;
        reader.readAsDataURL(file);
      });

      try {
        const resp = await fetch(PROXY_URL, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [{
              role: 'user', content: [
                { type:'text', text:'Please extract the exact text from the image as it appears. Do not provide any additional commentary or corrections.' },
                { type:'image_url', image_url:{ url:`data:${file.type};base64,${b64}` } }
              ]
            }],
            max_tokens: 500
          })
        });
        if (!resp.ok) throw new Error(resp.statusText);
        const { choices } = await resp.json();
        ta.value = choices?.[0]?.message?.content?.trim() || '';
        globalState.originalText[pageName] = ta.value; // Store original text
      } catch(err) {
        ta.value = 'OCR ì—ëŸ¬: ' + err.message;
        globalState.originalText[pageName] = ''; // Clear original text on error
      } finally {
        spinner.style.display = 'none';
      }
    }

    // --- Submit Function (shared logic, adapted for page IDs) ---
    async function handleSubmit(pageName) {
      const btn = document.getElementById(`submit-btn-${pageName}`);
      const sp  = document.getElementById(`submit-spinner-${pageName}`);
      const contentTextarea = document.getElementById(`contentText-${pageName}`);
      const resultDiv = document.getElementById(`result-${pageName}`);

      btn.disabled = true; sp.style.display = 'inline-block';

      const payload = { contentText: contentTextarea.value };
      globalState.originalText[pageName] = contentTextarea.value; // Store original text

      try {
          const res = await fetch(`${WORKER_URL}/api/feedback`, {
              method: 'POST',
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify(payload)
          });
          const data = await res.json();
          btn.disabled = false; sp.style.display = 'none';

          if (!res.ok) {
              resultDiv.innerHTML = `<p style="color:#cc0000;">Error ${res.status}: ${data.error?.message||data.error}</p>`;
              return;
          }

          const { feedback, modelAnswer } = data;
          globalState.feedback[pageName] = feedback;
          globalState.modelAnswer[pageName] = modelAnswer;

          // Render results based on the active page
          if (pageName === 'feedback-corner') {
              resultDiv.innerHTML = `
                <div class="box" id="feedback-box">
                    <h2>Feedback</h2>
                    <div id="feedback-content" class="editable-content" contenteditable="false">${feedback.replace(/\n/g,'<br>')}</div>
                    <button class="edit-btn" data-target="feedback-content">í¸ì§‘</button>
                    <button class="save-btn" data-target="feedback-content" style="display:none;">ì €ì¥</button>
                </div>
                <div class="box" id="model-answer-container-feedback">
                  <h2>ìˆ˜ì •ê¸€</h2>
                  <div class="model-box editable-content" id="model-answer-box-feedback" contenteditable="false">${modelAnswer.replace(/\n/g,'<br>')}</div>
                </div>
                <div class="result-actions">
                    <button id="print-btn-feedback" type="button">Print</button>
                    <div class="print-options" id="print-options-feedback">
                        <label><input type="checkbox" id="print-original-feedback" checked> ì›ë³¸</label>
                        <label><input type="checkbox" id="print-feedback-item" checked> Feedback</label>
                        <label><input type="checkbox" id="print-model-answer-feedback" checked> ìˆ˜ì •ê¸€</label>
                        <button id="confirm-print-btn-feedback">Confirm Print</button>
                    </div>
                </div>
              `;
              setupPageSpecificListeners('feedback-corner');
          } else if (pageName === 'final-output-corner') {
              resultDiv.innerHTML = `
                <div class="box" id="feedback-box-final-output" style="display:none;">
                    <h2>Feedback</h2>
                    <div id="feedback-content-final-output">${feedback.replace(/\n/g,'<br>')}</div>
                </div>
                <div class="box" id="model-answer-container-final-output">
                  <h2>ìˆ˜ì •ê¸€</h2>
                  <div class="model-box editable-content" id="model-answer-box-final-output" contenteditable="false">${modelAnswer.replace(/\n/g,'<br>')}</div>
                  <button class="edit-btn" data-target="model-answer-box-final-output">í¸ì§‘</button>
                  <button class="save-btn" data-target="model-answer-box-final-output" style="display:none;">ì €ì¥</button>
                </div>
                <div class="result-actions">
                    <button id="tts-btn-final-output">ì›ì–´ë¯¼ ìŒì„± ë“£ê¸°<span id="tts-spinner-final-output" class="spinner"></span></button>
                    <audio id="tts-audio-final-output" controls style="display:none;"></audio>
                    <a id="download-link-final-output">Download Audio</a>
                    <button id="print-btn-final-output" type="button">Print</button>
                    <div class="print-options" id="print-options-final-output">
                        <label><input type="checkbox" id="print-original-final-output" checked> ì›ë³¸</label>
                        <label><input type="checkbox" id="print-feedback-item-final-output" checked> Feedback</label>
                        <label><input type="checkbox" id="print-model-answer-final-output" checked> ìˆ˜ì •ê¸€</label>
                        <button id="confirm-print-btn-final-output">Confirm Print</button>
                    </div>
                </div>
              `;
              setupPageSpecificListeners('final-output-corner');
          }
      } catch (err) {
          btn.disabled = false; sp.style.display = 'none';
          resultDiv.innerHTML = `<p style="color:#cc0000;">Error: ${err.message}</p>`;
      }
    }

    // --- Page-specific Event Listener Setup ---
    function setupPageSpecificListeners(pageName) {
        // OCR Event Listener
        const contentFile = document.getElementById(`contentFile-${pageName}`);
        if (contentFile) {
            contentFile.removeEventListener('change', () => handleOCR(pageName)); // Prevent duplicate listeners
            contentFile.addEventListener('change', () => handleOCR(pageName));
        }

        // Submit Event Listener
        const form = document.getElementById(`feedback-form-${pageName}`);
        if (form) {
            form.removeEventListener('submit', (e) => { e.preventDefault(); handleSubmit(pageName); });
            form.addEventListener('submit', (e) => { e.preventDefault(); handleSubmit(pageName); });
        }


        // TTS Event Listener (only for final-output-corner)
        if (pageName === 'final-output-corner') {
            const ttsBtn = document.getElementById('tts-btn-final-output');
            if (ttsBtn) {
                ttsBtn.removeEventListener('click', handleTTS); // Prevent duplicate listeners
                ttsBtn.addEventListener('click', handleTTS);
            }
        }

        // Print Button - Show Options (for both pages)
        const printBtn = document.getElementById(`print-btn-${pageName}`);
        if (printBtn) {
            printBtn.removeEventListener('click', () => togglePrintOptions(pageName));
            printBtn.addEventListener('click', () => togglePrintOptions(pageName));
        }

        // Confirm Print Button - Handle Print Logic (for both pages)
        const confirmPrintBtn = document.getElementById(`confirm-print-btn-${pageName}`);
        if (confirmPrintBtn) {
            confirmPrintBtn.removeEventListener('click', () => handlePrint(pageName));
            confirmPrintBtn.addEventListener('click', () => handlePrint(pageName));
        }

        // Editable Content Logic (for both pages)
        const editButtons = document.querySelectorAll(`#result-${pageName} .edit-btn`);
        editButtons.forEach(btn => {
            btn.removeEventListener('click', (e) => toggleEdit(e, pageName)); // Prevent duplicate
            btn.addEventListener('click', (e) => toggleEdit(e, pageName));
        });

        const saveButtons = document.querySelectorAll(`#result-${pageName} .save-btn`);
        saveButtons.forEach(btn => {
            btn.removeEventListener('click', (e) => saveContent(e, pageName)); // Prevent duplicate
            btn.addEventListener('click', (e) => saveContent(e, pageName));
        });
    }


    // --- TTS Function ---
    async function handleTTS() {
        const ttsBtn = document.getElementById('tts-btn-final-output');
        const ttsSpinner = document.getElementById('tts-spinner-final-output');
        const download = document.getElementById('download-link-final-output');
        const audioEl = document.getElementById('tts-audio-final-output');

        ttsBtn.disabled = true;
        ttsSpinner.style.display = 'inline-block';
        download.style.display = 'none';
        audioEl.style.display = 'none';

        const pageName = 'final-output-corner'; // TTS is only for final-output-corner
        const text = globalState.modelAnswer[pageName]; // Use the potentially edited model answer

        if (!text) {
            alert('ìˆ˜ì •ê¸€ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ê¸€ì„ ì œì¶œí•˜ê±°ë‚˜ ìˆ˜ì •ê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.');
            ttsBtn.disabled = false;
            ttsSpinner.style.display = 'none';
            return;
        }

        try {
            const res = await fetch(`${WORKER_URL}/api/tts`, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ text })
            });

            const blob = await res.blob();
            const url = URL.createObjectURL(blob);

            audioEl.src = url;
            audioEl.style.display = 'block';
            ttsSpinner.style.display = 'none';
            ttsBtn.disabled = false;

            const safeFilename = 'model-answer-audio'.replace(/[\\\/:*?"<>|]/g, '_');
            download.href = url;
            download.download = `${safeFilename}.mp3`;
            download.style.display = 'block';
        } catch (error) {
            console.error("TTS Error:", error);
            alert("ìŒì„± í•©ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            ttsBtn.disabled = false;
            ttsSpinner.style.display = 'none';
        }
    }


    // --- Print Function ---
    function togglePrintOptions(pageName) {
        const printOptionsDiv = document.getElementById(`print-options-${pageName}`);
        printOptionsDiv.style.display = printOptionsDiv.style.display === 'block' ? 'none' : 'block';
    }

    function handlePrint(pageName) {
        const printOriginal = document.getElementById(`print-original-${pageName}`).checked;
        const printFeedback = document.getElementById(`print-feedback-item${pageName === 'feedback-corner' ? '' : '-final-output'}`).checked;
        const printModelAnswer = document.getElementById(`print-model-answer${pageName === 'feedback-corner' ? '' : '-final-output'}`).checked;

        let contentToPrint = '';

        if (printOriginal) {
            const originalText = globalState.originalText[pageName];
            const originalImageUrl = globalState.originalImageUrl[pageName];
            if (originalImageUrl) {
                 contentToPrint += `
                    <div class="print-content-item">
                        <h3>ì›ë³¸ ì´ë¯¸ì§€</h3>
                        <p><img src="${originalImageUrl}" style="max-width:100%; height:auto; display:block; margin:auto;"></p>
                    </div>
                `;
            } else if (originalText) {
                contentToPrint += `
                    <div class="print-content-item">
                        <h3>ì›ë³¸ í…ìŠ¤íŠ¸</h3>
                        <p>${originalText.replace(/\n/g,'<br>')}</p>
                    </div>
                `;
            }
        }

        // Use content from globalState which might have been edited
        const feedbackContent = globalState.feedback[pageName];
        const modelAnswerContent = globalState.modelAnswer[pageName];

        if (printFeedback && feedbackContent) {
            contentToPrint += `
                <div class="print-content-item">
                    <h3>Feedback</h3>
                    <div>${feedbackContent.replace(/\n/g,'<br>')}</div>
                </div>
            `;
        }

        if (printModelAnswer && modelAnswerContent) {
            contentToPrint += `
                <div class="print-content-item">
                    <h3>ìˆ˜ì •ê¸€</h3>
                    <div>${modelAnswerContent.replace(/\n/g,'<br>')}</div>
                </div>
            `;
        }

        if (contentToPrint === '') {
            alert("ì¶œë ¥í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }

        const printWindowHtml = `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Writing Assistant Print</title>
  <style>
    body { font-family: sans-serif; margin: 2cm; }
    .print-header { text-align: center; margin-bottom: 1.5cm; margin-top: 0; }
    .print-header img { max-height: 80px; margin-bottom: 0.5rem; }
    .print-header h2 { margin: 0; font-size: 1.4rem; color: #004a99; }
    .print-header p { margin-top: 0.5rem; }
    .print-section {
      margin-top: 1cm;
      padding: 1cm;
      border: 2px dashed #0066cc;
      min-height: 10cm;
    }
    .print-content-item {
        margin-bottom: 1cm;
        padding-bottom: 1cm;
        border-bottom: 1px dashed #ccc;
        page-break-inside: avoid; /* Ensure item itself doesn't break */
    }
    .print-content-item:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }
    .print-content-item h3 {
        color: #004a99;
        margin-top: 0;
    }
    @media print {
      header { page-break-inside: avoid; }
      section { page-break-inside: auto; }

      /* Hide all UI elements from main page, and show only print content */
      /* This is already handled by the main `@media print` rule above */
      /* No need to duplicate */
    }
  </style>
</head>
<body>
  <header class="print-header">
    <img src="logo.png" alt="School Logo"/> <h2>Writing Assistant Printout</h2>
    <p>Student Name: _____________________  Date: ________________</p>
  </header>
  <section class="print-section">
    <div id="print-content">
      ${contentToPrint}
    </div>
  </section>
  <script>
    window.onload = () => {
      window.print();
      window.onafterprint = () => window.close();
    };
  <\/script>
</body>
</html>
        `;

        const w = window.open('', '_blank', `width=${screen.availWidth},height=${screen.availHeight}`);
        w.document.write(printWindowHtml);
        w.document.close();

        // Hide print options after confirming
        document.getElementById(`print-options-${pageName}`).style.display = 'none';
    }

    // --- Editing Functionality ---
    function toggleEdit(event, pageName) {
        const targetId = event.target.dataset.target;
        const contentDiv = document.getElementById(targetId);
        const saveBtn = event.target.nextElementSibling; // Get the next sibling (save button)

        contentDiv.contentEditable = "true";
        contentDiv.focus();
        contentDiv.classList.add('editable-content'); // Add class for styling
        event.target.style.display = 'none'; // Hide edit button
        saveBtn.style.display = 'inline-block'; // Show save button
    }

    function saveContent(event, pageName) {
        const targetId = event.target.dataset.target;
        const contentDiv = document.getElementById(targetId);
        const editBtn = event.target.previousElementSibling; // Get the previous sibling (edit button)

        contentDiv.contentEditable = "false";
        contentDiv.classList.remove('editable-content'); // Remove class for styling
        event.target.style.display = 'none'; // Hide save button
        editBtn.style.display = 'inline-block'; // Show edit button

        // Update global state with edited content
        if (targetId.includes('feedback-content')) {
            globalState.feedback[pageName] = contentDiv.innerHTML.replace(/<br>/g, '\n');
        } else if (targetId.includes('model-answer-box')) {
            globalState.modelAnswer[pageName] = contentDiv.innerHTML.replace(/<br>/g, '\n');
        }
    }

    // --- Initial Setup ---
    document.addEventListener('DOMContentLoaded', () => {
        // Show the default page (Feedback Corner)
        showPage('feedback-corner-section');

        // Setup listeners for the initially active page
        setupPageSpecificListeners('feedback-corner');
        // Setup listeners for the other page initially (they will handle their own form submission)
        setupPageSpecificListeners('final-output-corner');
    });

  </script>
</body>
</html>
